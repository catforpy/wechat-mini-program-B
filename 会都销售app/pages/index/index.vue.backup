<template>
  <view class="index-page">
    <!-- é¡¶éƒ¨åŒºåŸŸå®¹å™¨ï¼ˆåŒ…å«æ ‡ç­¾æ ã€æœç´¢æ¡†ã€å¿«é€Ÿå…¥å£ï¼‰ -->
    <view class="top-area">
      <!-- é¡¶éƒ¨æ¨ªå‘æ ‡ç­¾æ ï¼ˆå…³æ³¨ã€æ¨èã€ä¸€çº§ç±»ç›®ï¼‰ -->
      <view class="top-tabs-container" :style="{ paddingTop: statusBarHeight + 'px' }">
        <scroll-view
          scroll-x
          class="top-tabs-scroll"
          show-scrollbar="false"
          :scroll-left="scrollLeft"
          :scroll-with-animation="true"
          :enhanced="true"
          :bounces="false"
          @scroll="handleTopTabScroll"
          @touchstart.stop="handleTouchStart"
          @touchend.stop="handleTouchEnd"
        >
          <view class="top-tabs-wrapper">
            <view
              v-for="(tab, index) in topTabs"
              :key="index"
              :id="'tab-' + index"
              :class="['top-tab-item', { active: currentTopTab === index }]"
              @click="handleTopTabChange(index)"
            >
              <text class="tab-text">{{ tab }}</text>
              <view v-if="currentTopTab === index" class="tab-underline"></view>
            </view>
          </view>
        </scroll-view>
      </view>

      <!-- æœç´¢æ¡†åŒºåŸŸ -->
      <view class="search-container">
        <view class="search-box">
          <text class="scan-icon">ğŸ“·</text>
          <input class="search-input" type="text" placeholder="æœç´¢å°ç¨‹åºæ¨¡æ¿" />
          <text class="camera-icon">ğŸ“·</text>
          <view class="search-btn">æœç´¢</view>
        </view>
      </view>

      <!-- å¿«é€Ÿå…¥å£ - æ¨ªå‘æ»‘åŠ¨çš„Logoå¡ç‰‡ -->
      <view class="quick-entry-container">
        <view class="quick-entry-header">
          <text class="section-title">å¿«é€Ÿå…¥å£</text>
          <view
            v-if="currentTopTabApps.length > 8"
            class="more-btn"
            @tap="toggleQuickEntryExpand"
          >
            <text class="more-text">{{ isQuickEntryExpanded ? 'æ”¶èµ·' : 'æ›´å¤š' }}</text>
            <text class="more-icon">{{ isQuickEntryExpanded ? 'â†‘' : 'â€º' }}</text>
          </view>
        </view>

        <!-- å•è¡Œæ¨ªå‘æ»šåŠ¨æ¨¡å¼ -->
        <view
          v-if="!isQuickEntryExpanded"
          class="quick-entry-scroll"
          @touchstart.stop
          @touchmove.stop
          @touchend.stop
          @touchcancel.stop
        >
          <view
            v-for="(app, index) in currentTopTabApps"
            :key="index"
            class="app-card"
            @click="handleAppClick(app)"
          >
            <view class="app-icon">
              <image v-if="app.icon && !app.emoji" :src="app.icon" mode="aspectFit" class="app-icon-image" />
              <text v-else class="app-emoji">{{ app.emoji || 'ğŸ“±' }}</text>
            </view>
            <text class="app-name">{{ app.name }}</text>
          </view>
        </view>

        <!-- å¤šè¡Œç½‘æ ¼/åˆ—è¡¨æ¨¡å¼ -->
        <scroll-view
          v-else
          class="quick-entry-expanded"
          scroll-y
          @touchstart.stop
          @touchmove.stop
          @touchend.stop
          @touchcancel.stop
        >
          <view class="app-grid-expanded">
            <view
              v-for="(app, index) in currentTopTabApps"
              :key="index"
              class="app-card-expanded"
              @click="handleAppClick(app)"
            >
              <view class="app-icon">
                <image v-if="app.icon && !app.emoji" :src="app.icon" mode="aspectFit" class="app-icon-image" />
                <text v-else class="app-emoji">{{ app.emoji || 'ğŸ“±' }}</text>
              </view>
              <text class="app-name">{{ app.name }}</text>
            </view>
          </view>
        </scroll-view>
      </view>

      <!-- å¹¿å‘Šå­—å¹•è½®æ’­ -->
      <view class="ad-ticker">
        <view class="ticker-content">
          <view class="ticker-scroll">
            <text class="ticker-text">{{ currentAdText }}</text>
          </view>
        </view>
      </view>

      <!-- å°ç¨‹åºæµè§ˆå…¥å£ -->
      <view class="mini-program-browse">
        <view class="browse-header">
          <text class="browse-title">å°ç¨‹åº</text>
          <view class="browse-btn" @tap="handleBrowseMiniPrograms">
            <text class="browse-text">æµè§ˆ</text>
            <text class="browse-arrow">â€º</text>
          </view>
        </view>
      </view>
    </view>

    <!-- é¡µé¢æ•´ä½“å†…å®¹å®¹å™¨ -->
    <view class="page-wrapper" :class="{ 'quick-entry-expanded-mode': isQuickEntryExpanded }">
    <!-- äºŒçº§ç±»ç›®+ä¸‰çº§ç±»ç›® -->
    <view class="content-container">
      <!-- å·¦ä¾§æ‚¬æµ®æŒ‰é’®ï¼ˆè§¦å‘äºŒçº§èœå•ï¼‰ -->
      <view class="floating-trigger" :class="{ 'menu-open': showSecondLevelMenu }" @click="toggleSecondLevelMenu">
        <text class="trigger-icon">{{ showSecondLevelMenu ? 'â€¹' : 'â€º' }}</text>
      </view>

      <!-- äºŒçº§ç±»ç›®å¼¹å‡ºé¢æ¿ -->
      <view
        :class="['second-level-panel', { show: showSecondLevelMenu }]"
        @click="showSecondLevelMenu = false"
      >
        <view class="panel-content" @click.stop>
          <scroll-view
            scroll-y
            class="panel-scroll"
            show-scrollbar={false}
            @touchstart.stop
            @touchmove.stop
            @touchend.stop
            @touchcancel.stop
          >
            <view
              v-for="(category, index) in currentSecondLevelCategories"
              :key="index"
              :class="['panel-item', { active: currentSecondLevel === index }]"
              @click="handleSecondLevelChange(index)"
            >
              {{ category.name }}
            </view>
          </scroll-view>
        </view>
      </view>

      <!-- å³ä¾§ä¸‰çº§ç±»ç›®ï¼ˆå°ç¨‹åºæ¨¡æ¿å¡ç‰‡ï¼‰ -->
      <view :class="['main-content', { 'shift-right': showSecondLevelMenu }]">
        <scroll-view
          scroll-y
          class="content-scroll"
          show-scrollbar={false}
          @touchstart.stop
          @touchmove.stop
          @touchend.stop
          @touchcancel.stop
        >
          <view class="category-title">{{ currentSecondLevelCategories[currentSecondLevel]?.name }}</view>
          <view class="mini-program-grid">
            <view
              v-for="(program, index) in currentMiniPrograms"
              :key="index"
              class="mini-program-card"
              :data-program="JSON.stringify(program)"
              @click="handleTemplateCardClick(program)"
            >
              <view class="program-icon-wrapper">
                <text class="program-emoji">{{ program.emoji || 'ğŸ“±' }}</text>
                <image
                  v-if="program.icon"
                  :src="program.icon"
                  mode="aspectFill"
                  class="program-icon"
                  @error="handleImageError($event, program)"
                  @load="handleImageLoad($event, program)"
                />
                <view v-if="program.isFollowed" class="follow-badge">â­</view>
              </view>
              <text class="program-name">{{ program.name }}</text>
              <view class="program-price-row">
                <text class="program-price">Â¥{{ program.price }}</text>
                <text class="program-price-dou">{{ program.price }}0éƒ½è¾¾è±†</text>
              </view>
            </view>
          </view>

          <!-- é•¿æŒ‰å¼¹å‡ºèœå•ï¼ˆå·²æ³¨é‡Š - ä¿ç•™å¤‡ç”¨ï¼‰-->
          <!--
          <view v-if="showActionMenu" class="action-menu-overlay" @tap="hideActionMenu">
            <view
              class="action-menu"
              :style="{ top: menuPosition.top + 'px', left: menuPosition.left + 'px' }"
              @tap.stop
            >
              <view
                v-if="!selectedProgram?.isFollowed"
                class="menu-item"
                @tap="handleMenuAction('follow')"
              >
                <text class="menu-text">å…³æ³¨</text>
              </view>
              <view
                v-else
                class="menu-item"
                @tap="handleMenuAction('unfollow')"
              >
                <text class="menu-text">å–æ¶ˆå…³æ³¨</text>
              </view>
              <view class="menu-item" @tap="handleMenuAction('register')">
                <text class="menu-text">æˆ‘è¦ç”³è¯·æ³¨å†Œ</text>
              </view>
              <view class="menu-item" @tap="handleMenuAction('cooperate')">
                <text class="menu-text">æˆ‘è¦ç”³è¯·åˆä½œ</text>
              </view>
              <view class="menu-item" @tap="handleMenuAction('rent')">
                <text class="menu-text">æˆ‘è¦ç”³è¯·ç§Ÿèµ</text>
              </view>
            </view>
          </view>
          -->
        </scroll-view>
      </view>
    </view>
    </view>

    <!-- ========== å°ç¨‹åºå®¹å™¨ç›¸å…³ä»£ç ï¼ˆå·²æ³¨é‡Š - 2025-02-09ï¼‰ ========== -->
    <!-- è¯¦æƒ…è¯·æŸ¥çœ‹æ–‡æ¡£ï¼šdocs/disabled-mini-program-container.md -->

    <!-- ä¸‹æ‹‰è¿›åº¦æŒ‡ç¤ºå™¨ï¼ˆå¾®ä¿¡é£æ ¼ï¼‰ -->
    <!--
    <view v-if="pullDownProgress > 0 && !showAppContainer" class="pull-down-indicator" :style="{
      opacity: pullDownProgress,
      transform: `translate(-50%, ${pullDownProgress * 80}px) scale(${0.8 + pullDownProgress * 0.4})`
    }">
      <view class="indicator-circle" :style="{
        borderColor: pullDownProgress >= 0.5 ? '#07c160' : 'rgba(0, 0, 0, 0.1)',
        transform: `rotate(${pullDownProgress * 360}deg)`
      }">
        <text class="indicator-icon" :style="{ color: pullDownProgress >= 0.5 ? '#07c160' : '#999' }">âŸ³</text>
      </view>
      <text class="indicator-text" :style="{ color: pullDownProgress >= 0.5 ? '#07c160' : '#999' }">
        {{ pullDownProgress >= 0.5 ? 'é‡Šæ”¾è¿›å…¥å°ç¨‹åº' : 'ç»§ç»­ä¸‹æ‹‰' }}
      </text>
    </view>
    -->

    <!-- æ¨¡ç³ŠèƒŒæ™¯å±‚ï¼ˆä¸‹æ‹‰æ—¶æ˜¾ç¤ºï¼‰ -->
    <!--
    <view v-if="pullDownProgress > 0 && !showAppContainer" class="blur-background" :style="{
      opacity: pullDownProgress * 0.5
    }"></view>
    -->

    <!-- å°ç¨‹åºå®¹å™¨å¼¹çª—ï¼ˆä¸‹æ‹‰è§¦å‘ï¼‰ -->
    <!--
    <view
      :class="['app-container-modal', { show: showAppContainer }]"
      :style="{
        paddingTop: statusBarHeight + 'px',
        backgroundColor: showAppContainer ? 'rgba(0, 0, 0, 0.75)' : `rgba(0, 0, 0, ${pullDownProgress * 0.75})`,
        opacity: showAppContainer ? 1 : pullDownProgress,
        backdropFilter: showAppContainer || pullDownProgress > 0.5 ? 'blur(20rpx)' : 'none',
        WebkitBackdropFilter: showAppContainer || pullDownProgress > 0.5 ? 'blur(20rpx)' : 'none'
      }"
    >
      <view class="modal-close-layer" @tap="hideAppContainer"></view>

      <view
        class="app-container-content"
        :style="{
          transform: `translateY(-${100 * (1 - pullDownProgress * 0.6)}%)`,
          opacity: showAppContainer ? 1 : pullDownProgress,
          transition: (showAppContainer && !isClosing) || isClosing ? 'transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94)' : 'none'
        }"
      >
        <view class="app-search-bar">
          <view class="search-input-wrapper">
            <text class="search-icon">ğŸ”</text>
            <input class="search-input" type="text" placeholder="æœç´¢å°ç¨‹åº" />
          </view>
        </view>

        <view class="app-section">
          <view class="section-header">
            <text class="section-title">æœ€è¿‘ä½¿ç”¨</text>
            <view class="section-action">
              <text class="action-icon">âœï¸</text>
              <text class="action-text">ç¼–è¾‘</text>
            </view>
          </view>
          <view class="app-grid">
            <view
              v-for="(app, index) in recentApps"
              :key="index"
              class="app-item"
              @click="openApp(app)"
            >
              <view class="app-icon">
                <image v-if="app.icon" :src="app.icon" mode="aspectFit" class="app-icon-image" />
                <text v-else class="app-emoji">{{ app.emoji || 'ğŸ“±' }}</text>
              </view>
              <text class="app-name-text">{{ app.name }}</text>
            </view>
          </view>
        </view>

        <view class="app-section discover-section">
          <view class="discover-card">
            <view class="discover-icon">ğŸ¯</view>
            <view class="discover-content">
              <text class="discover-title">å‘ç°</text>
              <text class="discover-desc">æ¢ç´¢æ›´å¤šä¼˜è´¨å°ç¨‹åº</text>
            </view>
          </view>
        </view>

        <view class="app-section">
          <view class="section-header">
            <text class="section-title">æˆ‘çš„å°ç¨‹åº</text>
            <view class="section-action">
              <text class="action-text">æ›´å¤š</text>
              <text class="action-icon">â€º</text>
            </view>
          </view>
          <view class="app-grid">
            <view
              v-for="(app, index) in myApps"
              :key="index"
              class="app-item"
              @click="openApp(app)"
            >
              <view class="app-icon">
                <image v-if="app.icon" :src="app.icon" mode="aspectFit" class="app-icon-image" />
                <text v-else class="app-emoji">{{ app.emoji || 'ğŸ“±' }}</text>
              </view>
              <text class="app-name-text">{{ app.name }}</text>
            </view>
          </view>
        </view>

        <view class="bottom-tip">
          <text class="tip-text">{{ showAppContainer ? 'ç‚¹å‡»ç©ºç™½å¤„å…³é—­' : 'å‘ä¸‹æ‹‰åŠ¨ä»¥æ‰“å¼€å°ç¨‹åºå®¹å™¨' }}</text>
        </view>
      </view>
    </view>
    -->
    <!-- ========== å°ç¨‹åºå®¹å™¨ç›¸å…³ä»£ç ç»“æŸ ========== -->
  </view>
</template>

<script setup lang="ts">
import { ref, computed, onMounted, nextTick } from 'vue'
import { getAllMergedCategories, type FirstLevelCategory } from '@/data/categories-by-entity'

// çŠ¶æ€æ é«˜åº¦
const statusBarHeight = ref(0)

// é¡¶éƒ¨æ ‡ç­¾æ æ•°æ®
const currentTopTab = ref(1) // é»˜è®¤é€‰ä¸­"æ¨è"

// å¿«é€Ÿå…¥å£å±•å¼€çŠ¶æ€
const isQuickEntryExpanded = ref(false)

// å¹¿å‘Šå­—å¹•æ•°æ®
const adsData = ref([
  'ğŸ‰ æ–°ç”¨æˆ·æ³¨å†Œå³é€100éƒ½è¾¾è±†ï¼',
  'ğŸ“¢ ä¼ä¸šè®¤è¯å¯å…è´¹é¢†å–10ä¸ªå°ç¨‹åºæ¨¡æ¿ï¼',
  'ğŸ”¥ é™æ—¶ä¼˜æƒ ï¼šé¤é¥®ç±»å°ç¨‹åº8æŠ˜ä¼˜æƒ ä¸­ï¼',
  'ğŸŒŸ æ¨èå¥½å‹è·å¾—é¢å¤–å¥–åŠ±ï¼',
  'ğŸ’¡ å®åè®¤è¯å³å¯è§£é”å…¨éƒ¨åŠŸèƒ½ï¼'
])
const currentAdIndex = ref(0)
const currentAdText = computed(() => adsData.value[currentAdIndex.value])

// æ»šåŠ¨ä½ç½®ï¼ˆä½¿ç”¨scroll-leftä»£æ›¿scroll-into-viewï¼‰
const scrollLeft = ref(0)

// æ ‡è®°æ˜¯å¦æ­£åœ¨é€šè¿‡ä»£ç è®¾ç½®æ»šåŠ¨ï¼ˆé¿å…æ»šåŠ¨äº‹ä»¶å†²çªï¼‰
const isProgrammaticScroll = ref(false)

// æœ€å°æ»šåŠ¨è¾¹ç•Œï¼ˆ"æ¨è"æ ‡ç­¾ä½ç½®ï¼‰ï¼Œä½œä¸ºæ»šåŠ¨é™åˆ¶
const minScrollLeft = ref(0)

// æ ‡è®°ç”¨æˆ·æ˜¯å¦æ­£åœ¨è§¦æ‘¸ï¼ˆç”¨äºåŒºåˆ†ç”¨æˆ·æ»‘åŠ¨å’Œæƒ¯æ€§æ»šåŠ¨ï¼‰
const isUserTouching = ref(false)

// è®°å½•è¾¹ç•Œé”å®šçŠ¶æ€ï¼ˆé˜²æ­¢è¿ç»­è§¦å‘ä¿®æ­£ï¼‰
const isBoundaryLocked = ref(false)

// ========== å°ç¨‹åºå®¹å™¨ç›¸å…³ä»£ç ï¼ˆå·²æ³¨é‡Š - 2025-02-09ï¼‰ ==========
/*
// å°ç¨‹åºå®¹å™¨ç›¸å…³çŠ¶æ€
const showAppContainer = ref(false)
const isClosing = ref(false) // æ˜¯å¦æ­£åœ¨å…³é—­
const pullDownProgress = ref(0)
const isSwipingUpToClose = ref(false) // æ˜¯å¦æ­£åœ¨ä¸Šæ»‘å…³é—­å°ç¨‹åºå®¹å™¨
let swipeUpStartX = 0 // ä¸Šæ»‘èµ·å§‹ä½ç½® X
let swipeUpStartY = 0 // ä¸Šæ»‘èµ·å§‹ä½ç½® Y

// æœ€è¿‘ä½¿ç”¨çš„å°ç¨‹åº
const recentApps = ref([
  { name: 'ä¼šéƒ½', icon: '/static/haidu.jpg', emoji: 'ğŸª', path: '/pages/template/retail' },
  { name: 'è¾¾ç®¡', icon: '/static/daguan.png', emoji: 'ğŸ“Š', path: '/pages/template/education' },
  { name: 'éƒ½è¾¾', icon: '/static/douda.png', emoji: 'ğŸšš', path: '/pages/template/logistics' },
  { name: 'é‡‘è¾¾', icon: '/static/jinda.jpg', emoji: 'ğŸ’°', path: '/pages/template/finance' },
  { name: 'æ•™è‚²é€š', icon: '', emoji: 'ğŸ“š', path: '/pages/template/education' },
  { name: 'åŒ»ç–—å¸®', icon: '', emoji: 'ğŸ¥', path: '/pages/template/medical' },
  { name: 'æ”¿åŠ¡é€š', icon: '', emoji: 'ğŸ›ï¸', path: '/pages/template/government' },
  { name: 'é¤é¥®æ˜“', icon: '', emoji: 'ğŸ½ï¸', path: '/pages/template/food' }
])

// æˆ‘çš„å°ç¨‹åº
const myApps = ref([
  { name: 'é›¶å”®é€š', icon: '', emoji: 'ğŸ›’', path: '/pages/template/retail' },
  { name: 'ç‰©æµå®', icon: '', emoji: 'ğŸ“¦', path: '/pages/template/logistics' },
  { name: 'ç”Ÿæ´»åœˆ', icon: '', emoji: 'ğŸŒŸ', path: '/pages/template/life' },
  { name: 'ä¼˜æ•™', icon: '', emoji: 'ğŸ“', path: '/pages/template/education' },
  { name: 'å¥åº·', icon: '', emoji: 'ğŸ’Š', path: '/pages/template/medical' },
  { name: 'ç¾é£Ÿ', icon: '', emoji: 'ğŸœ', path: '/pages/template/food' }
])
*/
// ========== å°ç¨‹åºå®¹å™¨ç›¸å…³ä»£ç ç»“æŸ ==========

// ========== å°ç¨‹åºå®¹å™¨ç›¸å…³ä»£ç ï¼ˆå·²æ³¨é‡Š - 2025-02-09ï¼‰ ==========
/*
// é¡µé¢æ»šåŠ¨ä½ç½®è·Ÿè¸ª
const isAtPageTop = ref(true) // æ˜¯å¦åœ¨é¡µé¢é¡¶éƒ¨

// ä¸‹æ‹‰è§¦æ‘¸èµ·å§‹ä½ç½®å’Œæ–¹å‘åˆ¤å®š
let touchStartX = 0
let touchStartY = 0
let touchCurrentX = 0
let touchCurrentY = 0
let touchDirection: 'horizontal' | 'vertical' | null = null // æ»‘åŠ¨æ–¹å‘é”å®š
const isPullingDown = ref(false)
const DIRECTION_LOCK_THRESHOLD = 10 // æ–¹å‘é”å®šé˜ˆå€¼ï¼ˆpxï¼‰

// é¡µé¢çº§åˆ«çš„ä¸‹æ‹‰æ‰‹åŠ¿å¤„ç†
// åŠ¨æ€è®¡ç®—ä¸‹æ‹‰é˜ˆå€¼ï¼ˆå±å¹•é«˜åº¦çš„1/3ï¼‰
const PULL_THRESHOLD = ref(100) // åˆå§‹å€¼ï¼Œä¼šåœ¨ onMounted ä¸­æ›´æ–°

// æ£€æŸ¥è§¦æ‘¸æ˜¯å¦åœ¨å¯æ»šåŠ¨å®¹å™¨å†…
const isTouchInScrollableArea = (e: any): boolean => {
  let target = e.target
  if (!target) return false

  // å¯æ»šåŠ¨çš„ç±»ååˆ—è¡¨
  const scrollableClasses = [
    'panel-scroll',      // äºŒçº§èœå•æ»šåŠ¨
    'content-scroll',     // ä¸‰çº§å†…å®¹æ»šåŠ¨
    'top-tabs-scroll',    // é¡¶éƒ¨æ ‡ç­¾æ»šåŠ¨
    'tabs-scroll',        // ä¸€çº§ç±»ç›®æ ‡ç­¾æ»šåŠ¨
    'quick-entry-scroll', // å¿«é€Ÿå…¥å£æ»šåŠ¨
    'panel-content',      // äºŒçº§èœå•å†…å®¹åŒº
    'main-content',       // ä¸‰çº§ç±»ç›®å†…å®¹åŒº
    'second-level-panel'  // äºŒçº§é¢æ¿
  ]

  // é€’å½’å‘ä¸Šæ£€æŸ¥çˆ¶å…ƒç´ (æœ€å¤šæ£€æŸ¥5å±‚)
  let depth = 0
  while (target && depth < 5) {
    const className = target.className || ''
    // å¤„ç†å„ç§ç±»å‹çš„ className
    const classStr = typeof className === 'string' ? className :
                     Array.isArray(className) ? className.join(' ') :
                     String(className)

    // æ£€æŸ¥æ˜¯å¦åŒ…å«ä»»ä½•å¯æ»šåŠ¨ç±»å
    for (const scrollableClass of scrollableClasses) {
      if (classStr.includes(scrollableClass)) {
        console.log('[é¡µé¢ä¸‹æ‹‰] è§¦æ‘¸åœ¨å¯æ»šåŠ¨åŒºåŸŸå†…:', scrollableClass)
        return true
      }
    }

    // å‘ä¸Šæ£€æŸ¥çˆ¶å…ƒç´ 
    target = target.parentElement
    depth++
  }

  return false
}
*/

// ========== å°ç¨‹åºå®¹å™¨ç›¸å…³ä»£ç ï¼ˆå·²æ³¨é‡Š - 2025-02-09ï¼‰ ==========
/*
// é¡µé¢è§¦æ‘¸å¼€å§‹
const handlePageTouchStart = (e: any) => {
  // å¦‚æœå°ç¨‹åºå®¹å™¨å·²æ˜¾ç¤ºï¼Œå‡†å¤‡å¤„ç†ä¸Šæ»‘å…³é—­
  if (showAppContainer.value) {
    isSwipingUpToClose.value = false
    swipeUpStartX = e.touches[0].clientX
    swipeUpStartY = e.touches[0].clientY
    touchDirection = null
    console.log('[ä¸Šæ»‘å…³é—­] è§¦æ‘¸å¼€å§‹, X:', swipeUpStartX, 'Y:', swipeUpStartY)
    return
  }

  // æ£€æŸ¥è§¦æ‘¸æ˜¯å¦åœ¨å¯æ»šåŠ¨åŒºåŸŸå†…
  if (isTouchInScrollableArea(e)) {
    console.log('[é¡µé¢ä¸‹æ‹‰] è§¦æ‘¸åœ¨æ»šåŠ¨åŒºåŸŸ,å¿½ç•¥ä¸‹æ‹‰')
    return
  }

  // é‡ç½®æ‰€æœ‰çŠ¶æ€
  isPullingDown.value = false
  touchDirection = null

  // è®°å½•èµ·å§‹ä½ç½®
  touchStartX = e.touches[0].clientX
  touchStartY = e.touches[0].clientY
  touchCurrentX = touchStartX
  touchCurrentY = touchStartY

  console.log('[é¡µé¢ä¸‹æ‹‰] è§¦æ‘¸å¼€å§‹, X:', touchStartX, 'Y:', touchStartY, 'é˜ˆå€¼:', PULL_THRESHOLD.value)
}

// é¡µé¢è§¦æ‘¸ç§»åŠ¨
const handlePageTouchMove = (e: any) => {
  // å¦‚æœå°ç¨‹åºå®¹å™¨å·²æ˜¾ç¤ºï¼Œå¤„ç†ä¸Šæ»‘å…³é—­æ‰‹åŠ¿
  if (showAppContainer.value) {
    const currentX = e.touches[0].clientX
    const currentY = e.touches[0].clientY
    const deltaX = Math.abs(currentX - swipeUpStartX)
    const deltaY = currentY - swipeUpStartY

    // æ–¹å‘åˆ¤å®š
    if (!touchDirection) {
      if (deltaX > DIRECTION_LOCK_THRESHOLD || Math.abs(deltaY) > DIRECTION_LOCK_THRESHOLD) {
        touchDirection = Math.abs(deltaY) > deltaX ? 'vertical' : 'horizontal'
        console.log('[ä¸Šæ»‘å…³é—­] æ–¹å‘é”å®šä¸º:', touchDirection)
      }
    }

    // å¦‚æœé”å®šä¸ºæ¨ªå‘æ»‘åŠ¨ï¼Œä¸å¤„ç†
    if (touchDirection === 'horizontal') {
      return
    }

    // åªå¤„ç†å‘ä¸Šæ»‘åŠ¨ï¼ˆdeltaY < 0ï¼‰
    if (deltaY < 0) {
      isSwipingUpToClose.value = true

      // è®¡ç®—ä¸Šæ»‘è·ç¦»ï¼ˆç»å¯¹å€¼ï¼‰
      const absDeltaY = Math.abs(deltaY)
      const threshold = PULL_THRESHOLD.value

      // ä½¿ç”¨é˜»å°¼æ•ˆæœï¼Œè®©æ‰‹æŒ‡æ»‘åŠ¨è·ç¦»å’Œæ»‘åŠ¨è·ç¦»åŸºæœ¬åŒ¹é…
      let dampenedDeltaY = absDeltaY
      if (absDeltaY > threshold * 0.4) {
        const excess = absDeltaY - threshold * 0.4
        dampenedDeltaY = threshold * 0.4 + excess * 0.3
      }

      // è®¡ç®—åå‘è¿›åº¦ (ä»1é€’å‡åˆ°0)
      const progress = Math.max(0, Math.min(1 - dampenedDeltaY / threshold, 1))
      pullDownProgress.value = progress

      console.log('[ä¸Šæ»‘å…³é—­] ä¸Šæ»‘è·ç¦»:', absDeltaY, 'é˜»å°¼å:', dampenedDeltaY, 'è¿›åº¦:', progress)
    }
    return
  }

  // æ£€æŸ¥è§¦æ‘¸æ˜¯å¦åœ¨å¯æ»šåŠ¨åŒºåŸŸå†…
  if (isTouchInScrollableArea(e)) {
    return
  }

  touchCurrentX = e.touches[0].clientX
  touchCurrentY = e.touches[0].clientY

  const deltaX = Math.abs(touchCurrentX - touchStartX)
  const deltaY = touchCurrentY - touchStartY

  // æ–¹å‘åˆ¤å®šï¼šå¦‚æœæ²¡æœ‰é”å®šæ–¹å‘ï¼Œå…ˆåˆ¤å®šæ–¹å‘
  if (!touchDirection) {
    if (deltaX > DIRECTION_LOCK_THRESHOLD || Math.abs(deltaY) > DIRECTION_LOCK_THRESHOLD) {
      // å“ªä¸ªæ–¹å‘ç§»åŠ¨è·ç¦»å¤§ï¼Œå°±é”å®šä¸ºå“ªä¸ªæ–¹å‘
      touchDirection = deltaX > Math.abs(deltaY) ? 'horizontal' : 'vertical'
      console.log('[é¡µé¢ä¸‹æ‹‰] æ–¹å‘é”å®šä¸º:', touchDirection)
    }
  }

  // å¦‚æœé”å®šä¸ºæ¨ªå‘æ»‘åŠ¨ï¼Œä¸å¤„ç†çºµå‘ä¸‹æ‹‰
  if (touchDirection === 'horizontal') {
    return
  }

  // åªåœ¨é”å®šä¸ºçºµå‘æ»‘åŠ¨ã€åœ¨é¡µé¢é¡¶éƒ¨ã€ä¸”å‘ä¸‹æ‹‰åŠ¨æ—¶ï¼Œæ‰å¤„ç†ä¸‹æ‹‰
  if (!isAtPageTop.value || deltaY <= 0) {
    return
  }

  // ä½¿ç”¨æ›´å¼ºçš„é˜»å°¼æ•ˆæœï¼šæ‰‹æŒ‡æ»‘åŠ¨è·ç¦»å’Œä¸‹æ‹‰è·ç¦»è¦åŸºæœ¬åŒ¹é…
  // å‰40%æ˜¯1:1ï¼Œ40%ä¹‹åä½¿ç”¨æ›´å°çš„é˜»å°¼ç³»æ•°(å¢åŠ ç²˜æ»æ€§)
  let dampenedDeltaY = deltaY
  if (deltaY > PULL_THRESHOLD.value * 0.4) {
    const excess = deltaY - PULL_THRESHOLD.value * 0.4
    dampenedDeltaY = PULL_THRESHOLD.value * 0.4 + excess * 0.3
  }

  // å®æ—¶è®¡ç®—ä¸‹æ‹‰è¿›åº¦ (0-1)
  const progress = Math.max(0, Math.min(dampenedDeltaY / PULL_THRESHOLD.value, 1))
  pullDownProgress.value = progress

  // æ ‡è®°ä¸ºæ­£åœ¨ä¸‹æ‹‰
  isPullingDown.value = true

  console.log('[é¡µé¢ä¸‹æ‹‰] æ‹‰åŠ¨è·ç¦»:', deltaY, 'é˜»å°¼å:', dampenedDeltaY, 'è¿›åº¦:', progress)
}

// é¡µé¢è§¦æ‘¸ç»“æŸ
const handlePageTouchEnd = () => {
  // å¦‚æœå°ç¨‹åºå®¹å™¨å·²æ˜¾ç¤º
  if (showAppContainer.value) {
    console.log('[ä¸Šæ»‘å…³é—­] è§¦æ‘¸ç»“æŸ, è¿›åº¦:', pullDownProgress.value, 'æ˜¯å¦ä¸Šæ»‘:', isSwipingUpToClose.value)

    // é‡ç½®æ–¹å‘é”å®š
    touchDirection = null

    // å¦‚æœæ­£åœ¨ä¸Šæ»‘ä¸”è¿›åº¦å°äºç­‰äº50%ï¼Œå…³é—­å°ç¨‹åºå®¹å™¨
    if (isSwipingUpToClose.value && pullDownProgress.value <= 0.5) {
      console.log('[ä¸Šæ»‘å…³é—­] è¾¾åˆ°å…³é—­é˜ˆå€¼ï¼Œå…³é—­å°ç¨‹åºå®¹å™¨')
      hideAppContainer()
    } else {
      // æœªè¾¾åˆ°å…³é—­é˜ˆå€¼ï¼Œæ¢å¤æ˜¾ç¤ºï¼ˆè¿›åº¦å›åˆ°1ï¼‰
      console.log('[ä¸Šæ»‘å…³é—­] æœªè¾¾åˆ°å…³é—­é˜ˆå€¼ï¼Œæ¢å¤æ˜¾ç¤º')
      pullDownProgress.value = 1
    }

    isSwipingUpToClose.value = false
    return
  }

  console.log('[é¡µé¢ä¸‹æ‹‰] è§¦æ‘¸ç»“æŸ, è¿›åº¦:', pullDownProgress.value, 'æ–¹å‘:', touchDirection)

  // é‡ç½®æ–¹å‘é”å®š
  touchDirection = null

  // é‡ç½®å…³é—­çŠ¶æ€
  isClosing.value = false

  // å¦‚æœä¸‹æ‹‰è¿›åº¦è¶…è¿‡é˜ˆå€¼ï¼ˆ50%ï¼‰ï¼Œæ˜¾ç¤ºå°ç¨‹åºå®¹å™¨
  if (pullDownProgress.value >= 0.5) {
    console.log('[é¡µé¢ä¸‹æ‹‰] è¾¾åˆ°é˜ˆå€¼ï¼Œæ˜¾ç¤ºå°ç¨‹åºå®¹å™¨')
    showAppContainer.value = true
    // æ˜¾ç¤ºåä¿æŒè¿›åº¦ä¸º1ï¼Œé¿å…å¼¹çª—æ¶ˆå¤±
    pullDownProgress.value = 1
  } else {
    // æœªè¾¾åˆ°é˜ˆå€¼ï¼Œå¼¹çª—é€€å›å»ï¼ˆè¿›åº¦å½’é›¶ï¼‰
    console.log('[é¡µé¢ä¸‹æ‹‰] æœªè¾¾åˆ°é˜ˆå€¼ï¼Œå¼¹çª—é€€å›')
    pullDownProgress.value = 0
  }

  isPullingDown.value = false
}

// ä¸»å†…å®¹æ»šåŠ¨äº‹ä»¶å¤„ç†
const handleMainContentScroll = (e: any) => {
  const scrollTop = e.detail.scrollTop
  isAtPageTop.value = scrollTop <= 0
}

// éšè—å°ç¨‹åºå®¹å™¨
const hideAppContainer = (e?: any) => {
  console.log('[å°ç¨‹åºå®¹å™¨] ========== hideAppContainer è¢«è°ƒç”¨ ==========')
  console.log('[å°ç¨‹åºå®¹å™¨] å½“å‰çŠ¶æ€ showAppContainer:', showAppContainer.value)
  console.log('[å°ç¨‹åºå®¹å™¨] å½“å‰è¿›åº¦ pullDownProgress:', pullDownProgress.value)
  console.log('[å°ç¨‹åºå®¹å™¨] äº‹ä»¶å¯¹è±¡:', e)

  if (isClosing.value) return

  // å¼€å§‹å…³é—­åŠ¨ç”»
  isClosing.value = true
  pullDownProgress.value = 0
  showAppContainer.value = false

  console.log('[å°ç¨‹åºå®¹å™¨] å·²è®¾ç½® isClosing = true')

  // ç­‰å¾…å…³é—­åŠ¨ç”»å®Œæˆåé‡ç½®æ ‡å¿—
  setTimeout(() => {
    isClosing.value = false
    console.log('[å°ç¨‹åºå®¹å™¨] å·²é‡ç½® isClosing = false')
  }, 300)
}

// æ‰“å¼€å°ç¨‹åº
const openApp = (app: any) => {
  console.log('æ‰“å¼€å°ç¨‹åº:', app.name)
  uni.showToast({
    title: `æ‰“å¼€${app.name}`,
    icon: 'none'
  })
  // TODO: è·³è½¬åˆ°å¯¹åº”å°ç¨‹åº
}
*/
// ========== å°ç¨‹åºå®¹å™¨ç›¸å…³ä»£ç ç»“æŸ ==========

/**
 * è®¡ç®—å¹¶æ»šåŠ¨åˆ°æŒ‡å®šæ ‡ç­¾
 */
const scrollTabIntoView = (index: number) => {
  console.log('>>> scrollTabIntoView è¢«è°ƒç”¨ï¼Œç›®æ ‡ç´¢å¼•:', index, 'æ ‡ç­¾å:', topTabs.value[index])

  nextTick(() => {
    setTimeout(() => {
      const query = uni.createSelectorQuery()

      // æŸ¥è¯¢æ‰€æœ‰æ ‡ç­¾å…ƒç´ ï¼ˆç”¨äºè®¡ç®—ç´¯ç§¯å®½åº¦ï¼‰
      const tabElements = topTabs.value.map((_, i) => `#tab-${i}`)

      console.log('å‡†å¤‡æŸ¥è¯¢çš„æ ‡ç­¾å…ƒç´ :', tabElements)

      // ä¸ºæ¯ä¸ªæ ‡ç­¾æ·»åŠ æŸ¥è¯¢
      tabElements.forEach(selector => {
        query.select(selector).boundingClientRect()
      })

      // æŸ¥è¯¢å®¹å™¨çš„ä½ç½®ä¿¡æ¯
      query.select('.top-tabs-scroll').boundingClientRect()

      query.exec((res) => {
        console.log('>>> query.exec ç»“æœè¿”å›ï¼Œres é•¿åº¦:', res?.length)

        if (!res || res.length < tabElements.length + 1) {
          console.log('=== æŸ¥è¯¢å¤±è´¥ï¼šç»“æœæ•°é‡ä¸è¶³ ===')
          console.log('æœŸæœ›æ•°é‡:', tabElements.length + 1, 'å®é™…æ•°é‡:', res?.length)
          return
        }

        console.log('=== æ»šåŠ¨åˆ°æ ‡ç­¾ ===')
        console.log('ç›®æ ‡ç´¢å¼•:', index, 'æ ‡ç­¾å:', topTabs.value[index])

        // è·å–ç³»ç»Ÿä¿¡æ¯ï¼Œç”¨äºrpxåˆ°pxçš„è½¬æ¢
        const systemInfo = uni.getSystemInfoSync()
        const screenWidth = systemInfo.screenWidth || 375
        const rpxToPx = screenWidth / 750 // rpxè½¬pxçš„æ¯”ä¾‹

        // è®¡ç®—ç›®æ ‡æ ‡ç­¾ä¹‹å‰æ‰€æœ‰æ ‡ç­¾çš„æ€»å®½åº¦ï¼ˆåŒ…æ‹¬ gapï¼‰
        let accumulatedWidth = 0
        const gapWidthRpx = 10 // CSS ä¸­å®šä¹‰çš„ gap: 10rpx
        const gapWidthPx = gapWidthRpx * rpxToPx // è½¬æ¢ä¸ºpx

        for (let i = 0; i < index; i++) {
          const rect = res[i] as any
          if (rect) {
            accumulatedWidth += rect.width
            // åŠ ä¸Š gapï¼ˆé™¤äº†æœ€åä¸€ä¸ªå…ƒç´ ï¼‰
            if (i < index - 1) {
              accumulatedWidth += gapWidthPx
            }
            console.log(`æ ‡ç­¾ ${i} (${topTabs.value[i]}) å®½åº¦:`, rect.width, 'ç´¯ç§¯:', accumulatedWidth)
          } else {
            console.log(`æ ‡ç­¾ ${i} æŸ¥è¯¢ç»“æœä¸ºç©º`)
          }
        }

        // å–æ•´ï¼Œé¿å…æµ®ç‚¹æ•°é—®é¢˜
        const targetScrollLeft = Math.round(accumulatedWidth)

        console.log('éœ€è¦æ»šåŠ¨çš„è·ç¦»:', targetScrollLeft)
        console.log('rpxè½¬pxæ¯”ä¾‹:', rpxToPx, 'gapå®½åº¦(px):', gapWidthPx)
        console.log('å½“å‰ scrollLeft:', scrollLeft.value)

        // å¦‚æœæ˜¯"æ¨è"æ ‡ç­¾ï¼ˆç´¢å¼•1ï¼‰ï¼Œä¿å­˜ä¸ºæœ€å°æ»šåŠ¨è¾¹ç•Œ
        if (index === 1) {
          minScrollLeft.value = targetScrollLeft
          console.log('=== è®¾ç½®æœ€å°æ»šåŠ¨è¾¹ç•Œ:', minScrollLeft.value)
        }

        // æ ‡è®°ä¸ºç¨‹åºåŒ–æ»šåŠ¨
        isProgrammaticScroll.value = true
        scrollLeft.value = targetScrollLeft

        console.log('è®¾ç½®å scrollLeft:', scrollLeft.value)

        // å»¶è¿Ÿé‡ç½®æ ‡è®°ï¼Œé¿å…å½±å“ç”¨æˆ·æ‰‹åŠ¨æ»‘åŠ¨
        setTimeout(() => {
          isProgrammaticScroll.value = false
        }, 500)
      })
    }, 200)
  })
}

/**
 * å¤„ç†è§¦æ‘¸å¼€å§‹äº‹ä»¶
 */
const handleTouchStart = () => {
  isUserTouching.value = true
  isBoundaryLocked.value = false
  console.log('[è§¦æ‘¸å¼€å§‹] ç”¨æˆ·å¼€å§‹è§¦æ‘¸')
}

/**
 * å¤„ç†è§¦æ‘¸ç»“æŸäº‹ä»¶
 */
const handleTouchEnd = () => {
  isUserTouching.value = false
  console.log('[è§¦æ‘¸ç»“æŸ] ç”¨æˆ·æ¾å¼€ï¼Œå¼€å§‹æƒ¯æ€§æ»šåŠ¨')

  // å»¶è¿Ÿæ£€æŸ¥ï¼Œå¦‚æœæƒ¯æ€§æ»šåŠ¨å¯¼è‡´è¶…è¿‡è¾¹ç•Œï¼Œè¿›è¡Œä¿®æ­£
  setTimeout(() => {
    if (scrollLeft.value < minScrollLeft.value) {
      console.log('[è§¦æ‘¸ç»“æŸåä¿®æ­£] æƒ¯æ€§æ»šåŠ¨è¶…è¿‡è¾¹ç•Œï¼Œä¿®æ­£åˆ°:', minScrollLeft.value)
      isBoundaryLocked.value = true
      isProgrammaticScroll.value = true
      scrollLeft.value = minScrollLeft.value

      // æŒç»­ä¿®æ­£ä¸€æ®µæ—¶é—´ï¼Œç¡®ä¿æƒ¯æ€§æ»šåŠ¨è¢«é˜»æ­¢
      let correctionCount = 0
      const maxCorrections = 10

      const correctScroll = () => {
        if (scrollLeft.value < minScrollLeft.value && correctionCount < maxCorrections) {
          scrollLeft.value = minScrollLeft.value
          correctionCount++
          setTimeout(correctScroll, 50)
        } else {
          // åœæ­¢ä¿®æ­£
          isBoundaryLocked.value = false
          isProgrammaticScroll.value = false
          console.log('[ä¿®æ­£å®Œæˆ] æ»šåŠ¨å·²é”å®šåœ¨è¾¹ç•Œ')
        }
      }

      setTimeout(correctScroll, 100)
    }
  }, 100)
}

/**
 * å¤„ç†é¡¶éƒ¨æ ‡ç­¾æ»šåŠ¨äº‹ä»¶
 * å®ç°æ»šåŠ¨è¾¹ç•Œï¼šç”¨æˆ·ä¸èƒ½å‘å³æ»šåŠ¨è¶…è¿‡"æ¨è"æ ‡ç­¾ï¼ˆæœ€å°è¾¹ç•Œï¼‰
 */
const handleTopTabScroll = (e: any) => {
  const currentScrollLeft = e.detail.scrollLeft

  // å¦‚æœæ˜¯ç¨‹åºåŒ–æ»šåŠ¨ï¼Œä¸å¤„ç†
  if (isProgrammaticScroll.value) {
    console.log('[ç¨‹åºåŒ–æ»šåŠ¨] ä½ç½®:', currentScrollLeft)
    return
  }

  // å¦‚æœè¾¹ç•Œå·²é”å®šï¼ŒæŒç»­ä¿®æ­£
  if (isBoundaryLocked.value) {
    console.log('[è¾¹ç•Œé”å®šä¸­] æŒç»­ä¿®æ­£æ»šåŠ¨ä½ç½®')
    scrollLeft.value = minScrollLeft.value
    return
  }

  // æ£€æŸ¥æ˜¯å¦è¶…è¿‡æœ€å°è¾¹ç•Œï¼ˆåªåœ¨ç”¨æˆ·éè§¦æ‘¸çŠ¶æ€ä¸‹è§¦å‘ä¿®æ­£ï¼‰
  if (currentScrollLeft < minScrollLeft.value && !isUserTouching.value) {
    console.log(`=== è¶…è¿‡æœ€å°è¾¹ç•Œï¼ˆæƒ¯æ€§æ»šåŠ¨ï¼‰ï¼Œè§¦å‘è¾¹ç•Œé”å®š ===`)
    console.log(`å½“å‰æ»šåŠ¨ä½ç½®: ${currentScrollLeft}, æœ€å°è¾¹ç•Œ: ${minScrollLeft.value}`)

    // é”å®šè¾¹ç•Œå¹¶ä¿®æ­£
    isBoundaryLocked.value = true
    isProgrammaticScroll.value = true
    scrollLeft.value = minScrollLeft.value

    // 100msåè§£é”ç¨‹åºåŒ–æ»šåŠ¨æ ‡è®°ï¼Œä½†ä¿æŒè¾¹ç•Œé”å®š
    setTimeout(() => {
      isProgrammaticScroll.value = false
    }, 100)

    // 500msåå®Œå…¨è§£é™¤è¾¹ç•Œé”å®š
    setTimeout(() => {
      isBoundaryLocked.value = false
      console.log('[è¾¹ç•Œè§£é”] å…è®¸è‡ªç”±æ»šåŠ¨')
    }, 500)

    return
  }

  // ç”¨æˆ·æ‰‹åŠ¨æ»šåŠ¨ï¼Œåœ¨å…è®¸èŒƒå›´å†…
  if (isUserTouching.value) {
    console.log('[ç”¨æˆ·æ»šåŠ¨ä¸­] ä½ç½®:', currentScrollLeft, 'æœ€å°è¾¹ç•Œ:', minScrollLeft.value)
  } else {
    console.log('[æƒ¯æ€§æ»šåŠ¨] ä½ç½®:', currentScrollLeft, 'æœ€å°è¾¹ç•Œ:', minScrollLeft.value)
  }
}

// æ‰€æœ‰åˆå¹¶çš„ç±»ç›®ï¼ˆåŒ…å«ä¼ä¸šã€ä¸ªäººã€å¢ƒå¤–ï¼‰
const allMergedCategories = ref<FirstLevelCategory[]>([])

// é¡¶éƒ¨æ ‡ç­¾æ 
const topTabs = computed(() => {
  // åŠ¨æ€ç”Ÿæˆï¼šå…³æ³¨ã€æ¨èã€ä»¥åŠæ‰€æœ‰ä¸€çº§ç±»ç›®
  const firstLevelCategories = allMergedCategories.value.map(c => c.name)
  return ['å…³æ³¨', 'æ¨è', ...firstLevelCategories]
})

onMounted(() => {
  console.log('[é¦–é¡µ] ========== æ£€æŸ¥å±å¹•æ–¹å‘ ==========')

  const systemInfo = uni.getSystemInfoSync()
  const windowWidth = systemInfo.windowWidth || 0
  const windowHeight = systemInfo.windowHeight || 0
  const screenWidth = systemInfo.screenWidth || 0
  const screenHeight = systemInfo.screenHeight || 0

  const isLandscape = windowWidth > windowHeight
  console.log('[é¦–é¡µ] çª—å£å°ºå¯¸ - å®½:', windowWidth, 'é«˜:', windowHeight)
  console.log('[é¦–é¡µ] å±å¹•å°ºå¯¸ - å®½:', screenWidth, 'é«˜:', screenHeight)
  console.log('[é¦–é¡µ] å½“å‰æ˜¯å¦æ¨ªå±:', isLandscape ? 'âŒ æ˜¯æ¨ªå±' : 'âœ“ æ˜¯ç«–å±')

  if (isLandscape) {
    console.log('[é¦–é¡µ] âš ï¸âš ï¸âš ï¸ è­¦å‘Š:é¦–é¡µæ˜¯æ¨ªå±!')
  }

  statusBarHeight.value = systemInfo.statusBarHeight || 0

  // ========== å°ç¨‹åºå®¹å™¨ç›¸å…³ä»£ç ï¼ˆå·²æ³¨é‡Š - 2025-02-09ï¼‰ ==========
  /*
  // è®¡ç®—ä¸‹æ‹‰é˜ˆå€¼ï¼šå±å¹•é«˜åº¦çš„ 1/3
  PULL_THRESHOLD.value = Math.floor(screenHeight / 3)
  console.log('[é¡µé¢ä¸‹æ‹‰] å±å¹•é«˜åº¦:', screenHeight, 'ä¸‹æ‹‰é˜ˆå€¼:', PULL_THRESHOLD.value)
  */
  // ========== å°ç¨‹åºå®¹å™¨ç›¸å…³ä»£ç ç»“æŸ ==========

  // åŠ è½½æ‰€æœ‰åˆå¹¶çš„ç±»ç›®æ•°æ®
  allMergedCategories.value = getAllMergedCategories()
  console.log('æ‰€æœ‰åˆå¹¶çš„ç±»ç›®æ•°é‡:', allMergedCategories.value.length)

  // åŠ è½½å…³æ³¨çš„å°ç¨‹åºåˆ—è¡¨
  loadFollowedPrograms()

  // ç­‰å¾…DOMæ›´æ–°åï¼Œåˆå§‹åŒ–æ»šåŠ¨åˆ°"æ¨è"æ ‡ç­¾ä½ç½®
  nextTick(() => {
    setTimeout(() => {
      scrollTabIntoView(1)
    }, 300)
  })

  // å¯åŠ¨å¹¿å‘Šå­—å¹•è‡ªåŠ¨è½®æ’­ï¼ˆæ¯3ç§’åˆ‡æ¢ä¸€æ¬¡ï¼‰
  setInterval(() => {
    currentAdIndex.value = (currentAdIndex.value + 1) % adsData.value.length
  }, 3000)
})

// åˆ‡æ¢é¡¶éƒ¨æ ‡ç­¾
const handleTopTabChange = (index: number) => {
  currentTopTab.value = index
  isQuickEntryExpanded.value = false // åˆ‡æ¢æ ‡ç­¾æ—¶é‡ç½®å±•å¼€çŠ¶æ€
  currentSecondLevel.value = 0 // åˆ‡æ¢æ ‡ç­¾æ—¶é‡ç½®äºŒçº§ç±»ç›®ç´¢å¼•
  scrollTabIntoView(index) // æ»šåŠ¨åˆ°é€‰ä¸­çš„æ ‡ç­¾

  // å¦‚æœåˆ‡æ¢åˆ°"å…³æ³¨"æ ‡ç­¾ï¼Œé‡æ–°åŠ è½½å…³æ³¨åˆ—è¡¨
  if (index === 0) {
    loadFollowedPrograms()
  }

  console.log('åˆ‡æ¢é¡¶éƒ¨æ ‡ç­¾:', topTabs.value[index])
}

// åˆ‡æ¢å¿«é€Ÿå…¥å£å±•å¼€/æ”¶èµ·
const toggleQuickEntryExpand = () => {
  isQuickEntryExpanded.value = !isQuickEntryExpanded.value
}

// ç±»å‹å®šä¹‰
interface TemplateInfo {
  name: string
  desc: string
}

interface QuickEntryApp {
  name: string
  icon: string
  path: string
  emoji?: string
}

// å½“å‰é€‰ä¸­ç´¢å¼•
const currentFirstLevel = ref(0)
const currentSecondLevel = ref(0)

// äºŒçº§èœå•é¢æ¿æ˜¾ç¤ºçŠ¶æ€
const showSecondLevelMenu = ref(false)

// åˆ‡æ¢äºŒçº§èœå•æ˜¾ç¤º/éšè—
const toggleSecondLevelMenu = () => {
  showSecondLevelMenu.value = !showSecondLevelMenu.value
}

// å®šä¹‰ä¸åŒæ ‡ç­¾çš„åº”ç”¨æ•°æ®
const tabAppsData: Record<string, QuickEntryApp[]> = {
  'å…³æ³¨': [
    {
      name: 'ä¼šéƒ½',
      icon: '/static/logo.jpg',
      path: '/pages/template/retail'
    },
    {
      name: 'è¾¾ç®¡',
      icon: '/static/daguan.png',
      path: '/pages/template/education'
    },
    {
      name: 'éƒ½è¾¾',
      icon: '/static/douda.png',
      path: '/pages/template/food'
    },
    {
      name: 'é‡‘è¾¾',
      icon: '/static/jinda.jpg',
      path: '/pages/template/life'
    },
    {
      name: 'æ•™è‚²é€š',
      icon: '',
      path: '/pages/template/education',
      emoji: 'ğŸ“š'
    },
    {
      name: 'åŒ»ç–—å¸®',
      icon: '',
      path: '/pages/template/medical',
      emoji: 'ğŸ¥'
    },
    {
      name: 'æ”¿åŠ¡é€š',
      icon: '',
      path: '/pages/template/government',
      emoji: 'ğŸ›ï¸'
    },
    {
      name: 'ç‰©æµå®',
      icon: '',
      path: '/pages/template/logistics',
      emoji: 'ğŸ“¦'
    }
  ],
  'æ¨è': [
    {
      name: 'ä¼šéƒ½',
      icon: '/static/logo.jpg',
      path: '/pages/template/retail'
    },
    {
      name: 'è¾¾ç®¡',
      icon: '/static/daguan.png',
      path: '/pages/template/education'
    },
    {
      name: 'éƒ½è¾¾',
      icon: '/static/douda.png',
      path: '/pages/template/food'
    },
    {
      name: 'é‡‘è¾¾',
      icon: '/static/jinda.jpg',
      path: '/pages/template/life'
    },
    {
      name: 'é›¶å”®æ˜“',
      icon: '',
      path: '/pages/template/retail',
      emoji: 'ğŸ›’'
    },
    {
      name: 'é¤é¥®é€š',
      icon: '',
      path: '/pages/template/food',
      emoji: 'ğŸ½ï¸'
    },
    {
      name: 'ç”Ÿæ´»åœˆ',
      icon: '',
      path: '/pages/template/life',
      emoji: 'ğŸŒŸ'
    },
    {
      name: 'ä¼˜æ•™',
      icon: '',
      path: '/pages/template/education',
      emoji: 'ğŸ“'
    },
    {
      name: 'åŒ»ç–—é€š',
      icon: '',
      path: '/pages/template/medical',
      emoji: 'ğŸ¥'
    },
    {
      name: 'æ”¿åŠ¡å®',
      icon: '',
      path: '/pages/template/government',
      emoji: 'ğŸ›ï¸'
    },
    {
      name: 'ç‰©æµå¿«',
      icon: '',
      path: '/pages/template/logistics',
      emoji: 'ğŸ“¦'
    },
    {
      name: 'é‡‘èé€š',
      icon: '',
      path: '/pages/template/finance',
      emoji: 'ğŸ’°'
    },
    {
      name: 'æ—…æ¸¸é€š',
      icon: '',
      path: '/pages/template/travel',
      emoji: 'âœˆï¸'
    },
    {
      name: 'é…’åº—å¸®',
      icon: '',
      path: '/pages/template/hotel',
      emoji: 'ğŸ¨'
    }
  ],
  // ç”µå•†é›¶å”®ç±»
  'ç”µå•†é›¶å”®': [
    {
      name: 'é›¶å”®æ˜“',
      icon: '',
      path: '/pages/template/retail',
      emoji: 'ğŸ›’'
    },
    {
      name: 'å•†åŸé€š',
      icon: '',
      path: '/pages/template/mall',
      emoji: 'ğŸª'
    },
    {
      name: 'å›¢è´­å®',
      icon: '',
      path: '/pages/template/groupbuy',
      emoji: 'ğŸ«'
    },
    {
      name: 'ç¤¾åŒºè´­',
      icon: '',
      path: '/pages/template/community',
      emoji: 'ğŸ˜ï¸'
    },
    {
      name: 'ç”Ÿé²œè¾¾',
      icon: '',
      path: '/pages/template/fresh',
      emoji: 'ğŸ¥¬'
    },
    {
      name: 'æ¯å©´é€š',
      icon: '',
      path: '/pages/template/maternity',
      emoji: 'ğŸ‘¶'
    },
    {
      name: 'ç¾å¦†å¸®',
      icon: '',
      path: '/pages/template/beauty',
      emoji: 'ğŸ’„'
    },
    {
      name: 'æœè£…åŸ',
      icon: '',
      path: '/pages/template/clothing',
      emoji: 'ğŸ‘—'
    },
    {
      name: 'æ•°ç æ¸¯',
      icon: '',
      path: '/pages/template/digital',
      emoji: 'ğŸ“±'
    },
    {
      name: 'å®¶å±…æ˜“',
      icon: '',
      path: '/pages/template/home',
      emoji: 'ğŸ '
    }
  ],
  // é¤é¥®ç¾é£Ÿç±»
  'é¤é¥®ç¾é£Ÿ': [
    {
      name: 'é¤é¥®é€š',
      icon: '',
      path: '/pages/template/food',
      emoji: 'ğŸ½ï¸'
    },
    {
      name: 'ç‚¹é¤å®',
      icon: '',
      path: '/pages/template/order',
      emoji: 'ğŸ“‹'
    },
    {
      name: 'å¤–å–è¾¾',
      icon: '',
      path: '/pages/template/delivery',
      emoji: 'ğŸ›µ'
    },
    {
      name: 'å’–å•¡é€š',
      icon: '',
      path: '/pages/template/coffee',
      emoji: 'â˜•'
    },
    {
      name: 'å¥¶èŒ¶å¸®',
      icon: '',
      path: '/pages/template/tea',
      emoji: 'ğŸ§‹'
    },
    {
      name: 'ç¾é£Ÿè¡—',
      icon: '',
      path: '/pages/template/foodstreet',
      emoji: 'ğŸœ'
    },
    {
      name: 'é›¶é£Ÿå±‹',
      icon: '',
      path: '/pages/template/snacks',
      emoji: 'ğŸ¿'
    },
    {
      name: 'ç”Ÿé²œé€Ÿ',
      icon: '',
      path: '/pages/template/freshfood',
      emoji: 'ğŸ¥©'
    }
  ],
  // ç‰©æµæœåŠ¡ç±»
  'ç‰©æµæœåŠ¡': [
    {
      name: 'ç‰©æµå¿«',
      icon: '',
      path: '/pages/template/logistics',
      emoji: 'ğŸ“¦'
    },
    {
      name: 'å¿«é€’é€š',
      icon: '',
      path: '/pages/template/express',
      emoji: 'ğŸšš'
    },
    {
      name: 'è´§è¿å®',
      icon: '',
      path: '/pages/template/freight',
      emoji: 'ğŸš›'
    },
    {
      name: 'ä»“å‚¨é€š',
      icon: '',
      path: '/pages/template/warehouse',
      emoji: 'ğŸ­'
    },
    {
      name: 'é…é€è¾¾',
      icon: '',
      path: '/pages/template/distribution',
      emoji: 'ğŸš²'
    },
    {
      name: 'å†·é“¾é€š',
      icon: '',
      path: '/pages/template/coldchain',
      emoji: 'â„ï¸'
    }
  ]
  // å…¶ä»–ç±»ç›®å¯ä»¥ç»§ç»­æ·»åŠ ...
}

// å½“å‰é¡¶éƒ¨æ ‡ç­¾å¯¹åº”çš„åº”ç”¨åˆ—è¡¨
const currentTopTabApps = computed(() => {
  const currentTabName = topTabs.value[currentTopTab.value]
  // ä¼˜å…ˆä»tabAppsDataä¸­æŸ¥æ‰¾å¯¹åº”ç±»åˆ«çš„åº”ç”¨
  if (tabAppsData[currentTabName]) {
    return tabAppsData[currentTabName]
  }
  // å¦‚æœæ‰¾ä¸åˆ°ï¼Œè¿”å›æ¨èçš„åº”ç”¨åˆ—è¡¨ä½œä¸ºé»˜è®¤
  return tabAppsData['æ¨è'] || []
})

// å½“å‰ç±»ç›®æ•°æ®ï¼ˆä½¿ç”¨æ‰€æœ‰åˆå¹¶çš„ç±»ç›®ï¼‰
const currentCategories = computed(() => {
  return allMergedCategories.value
})

// å½“å‰äºŒçº§ç±»ç›®ï¼ˆæ ¹æ®é¡¶éƒ¨æ ‡ç­¾é€‰æ‹©ï¼Œå‰ä¸¤ä¸ªæ ‡ç­¾[å…³æ³¨][æ¨è]ä¸æ˜¾ç¤ºäºŒçº§èœå•ï¼‰
const currentSecondLevelCategories = computed(() => {
  // å‰ä¸¤ä¸ªæ ‡ç­¾[å…³æ³¨]å’Œ[æ¨è]æ²¡æœ‰å¯¹åº”çš„äºŒçº§ç±»ç›®
  if (currentTopTab.value < 2) {
    return []
  }
  // ä»ç¬¬ä¸‰ä¸ªæ ‡ç­¾å¼€å§‹ï¼Œå¯¹åº”ç´¢å¼•ä¸º currentTopTab - 2
  const categoryIndex = currentTopTab.value - 2
  return currentCategories.value[categoryIndex]?.secondLevel || []
})

// å½“å‰ä¸‰çº§ç±»ç›®æ¨¡æ¿
const currentThirdLevelTemplates = computed(() => {
  return currentSecondLevelCategories.value[currentSecondLevel.value]?.templates || []
})

// å°ç¨‹åºå¡ç‰‡æ•°æ®ï¼ˆæ¨¡æ‹Ÿå·²ä¸Šæ¶çš„å°ç¨‹åºï¼‰
interface MiniProgram {
  id: string
  name: string
  desc?: string
  emoji?: string
  icon?: string
  price: string
  isFollowed: boolean
}

// æ‰€æœ‰å°ç¨‹åºæ¨¡æ¿çš„åŸºç¡€æ•°æ®ï¼ˆç”¨äºå…³æ³¨å’Œæ¨èï¼‰
const allMiniPrograms = ref<MiniProgram[]>([
  {
    id: '1',
    name: 'é¤é¥®ç‚¹é¤ç³»ç»Ÿ',
    emoji: 'ğŸ”',
    icon: '/static/logo.jpg',
    price: '599',
    isFollowed: false
  },
  {
    id: '2',
    name: 'é›¶å”®å•†åŸ',
    emoji: 'ğŸ›’',
    icon: '/static/logo.jpg',
    price: '799',
    isFollowed: false
  },
  {
    id: '3',
    name: 'åœ¨çº¿æ•™è‚²å¹³å°',
    emoji: 'ğŸ“',
    icon: '/static/logo.jpg',
    price: '999',
    isFollowed: false
  },
  {
    id: '4',
    name: 'ç¾ä¸šé¢„çº¦',
    emoji: 'ğŸ’…',
    icon: '/static/logo.jpg',
    price: '499',
    isFollowed: false
  },
  {
    id: '5',
    name: 'é…’åº—é¢„è®¢',
    emoji: 'ğŸ¨',
    icon: '/static/logo.jpg',
    price: '699',
    isFollowed: false
  },
  {
    id: '6',
    name: 'ç”Ÿé²œé…é€',
    emoji: 'ğŸ¥¬',
    icon: '/static/logo.jpg',
    price: '899',
    isFollowed: false
  }
])

// å·²å…³æ³¨çš„å°ç¨‹åºåˆ—è¡¨ï¼ˆä»æœ¬åœ°å­˜å‚¨åŠ è½½ï¼‰
const followedPrograms = ref<MiniProgram[]>([])

// å°ç¨‹åºå¡ç‰‡æ•°æ®ï¼ˆæ ¹æ®å½“å‰äºŒçº§ç±»ç›®çš„æ¨¡æ¿åŠ¨æ€ç”Ÿæˆï¼‰
const currentMiniPrograms = computed(() => {
  // "å…³æ³¨"æ ‡ç­¾ï¼šæ˜¾ç¤ºå·²å…³æ³¨çš„å°ç¨‹åº
  if (currentTopTab.value === 0) {
    return followedPrograms.value
  }

  // "æ¨è"æ ‡ç­¾ï¼šæ˜¾ç¤ºæ¨èçš„å°ç¨‹åº
  if (currentTopTab.value === 1) {
    return allMiniPrograms.value.slice(0, 6) // æ˜¾ç¤ºå‰6ä¸ªä½œä¸ºæ¨è
  }

  // å…¶ä»–æ ‡ç­¾ï¼šæ ¹æ®å½“å‰äºŒçº§ç±»ç›®çš„æ¨¡æ¿ç”Ÿæˆ
  const templates = currentSecondLevelCategories.value[currentSecondLevel.value]?.templates || []

  // å¦‚æœæ²¡æœ‰æ¨¡æ¿ï¼Œæ˜¾ç¤ºç©ºæ•°ç»„
  if (templates.length === 0) {
    return []
  }

  // å°†æ¨¡æ¿æ•°æ®è½¬æ¢ä¸ºå°ç¨‹åºå¡ç‰‡æ ¼å¼
  const programs = templates.map((template, index) => {
    const categoryName = currentSecondLevelCategories.value[currentSecondLevel.value]?.name || ''
    // ä½¿ç”¨æœ¬åœ°å›¾ç‰‡ï¼Œç¡®ä¿å›¾ç‰‡èƒ½åŠ è½½
    const imageUrl = '/static/logo.jpg'

    return {
      id: `${currentFirstLevel.value}_${currentSecondLevel.value}_${index}`,
      name: template.name,
      desc: template.desc,
      icon: imageUrl,
      emoji: getTemplateEmoji(categoryName),
      price: Math.floor(Math.random() * 500 + 99).toString(), // éšæœºä»·æ ¼ 99-599
      isFollowed: false
    }
  })

  return programs
})

// æ ¹æ®ç±»ç›®åç§°è·å–å¯¹åº”çš„emoji
const getTemplateEmoji = (categoryName: string) => {
  const emojiMap: Record<string, string> = {
    'æ”¶ä»¶/æ´¾ä»¶': 'ğŸ“¦',
    'æŸ¥ä»¶': 'ğŸ”',
    'è£…å¸æ¬è¿': 'ğŸ“¦',
    'ä»“å‚¨ç®¡ç†': 'ğŸ­',
    'å¿«é€’æŸœ': 'ğŸ“®',
    'è´§ç‰©è¿è¾“': 'ğŸšš',
    'å­¦å†æ•™è‚²ï¼ˆåŸ¹è®­æœºæ„ï¼‰': 'ğŸ“',
    'åœ¨çº¿è§†é¢‘è¯¾ç¨‹': 'ğŸ“º',
    'å©´å¹¼å„¿æ•™è‚²': 'ğŸ‘¶',
    'ç´ è´¨æ•™è‚²': 'ğŸ¨',
    'äº’è”ç½‘åŒ»é™¢': 'ğŸ¥',
    'å°±åŒ»æœåŠ¡': 'ğŸ’Š',
    'è¯å“ä¿¡æ¯å±•ç¤º': 'ğŸ’Š',
    'ä¸½äººæœåŠ¡': 'ğŸ’…',
    'å®¶æ”¿æœåŠ¡': 'ğŸ§¹',
    'å® ç‰©åŒ»é™¢/å…½åŒ»': 'ğŸ•',
    'å® ç‰©ï¼ˆéåŒ»é™¢ç±»ï¼‰': 'ğŸ¾',
    'å©šåº†æœåŠ¡': 'ğŸ’’',
    'ç‚¹é¤å¹³å°': 'ğŸœ',
    'å¤–å–å¹³å°': 'ğŸ¥¡',
    'é¤å…æ’é˜Ÿ': 'ğŸ”¢',
    'æ™¯åŒºæœåŠ¡': 'ğŸ”',
    'ä½å®¿æœåŠ¡': 'ğŸ¨',
    'æ—…è¡Œç¤¾': 'âœˆï¸',
    'è®°è´¦': 'ğŸ’°',
    'æ—¥å†': 'ğŸ“…',
    'å¤©æ°”': 'ğŸŒ¤ï¸',
    'å¤‡å¿˜å½•': 'ğŸ“',
    'æ³•å¾‹æœåŠ¡å¹³å°': 'âš–ï¸',
    'ä¼ä¸šç®¡ç†': 'ğŸ’¼',
    'ä¼šå±•æœåŠ¡': 'ğŸª'
  }
  return emojiMap[categoryName] || 'ğŸ“±'
}

// é•¿æŒ‰èœå•çŠ¶æ€
const showActionMenu = ref(false)
const menuPosition = ref({ top: 0, left: 0 })
const selectedProgram = ref<MiniProgram | null>(null)

// å¡ç‰‡é•¿æŒ‰ç›¸å…³çŠ¶æ€
const cardTouchTimers = ref<Map<string, any>>(new Map())

// ç‚¹å‡»æ¨¡æ¿å¡ç‰‡ï¼ˆè·³è½¬åˆ°æ¨¡æ¿è¯¦æƒ…é¡µï¼‰
const handleTemplateCardClick = (program: MiniProgram) => {
  console.log('ç‚¹å‡»æ¨¡æ¿å¡ç‰‡:', program)

  // è·å–å½“å‰äºŒçº§ç±»ç›®ä¿¡æ¯ï¼ˆåŒ…å«èµ„è´¨è¦æ±‚ï¼‰
  const currentSecondLevelCategory = currentSecondLevelCategories.value[currentSecondLevel.value]
  const currentFirstLevelCategory = currentCategories.value[currentFirstLevel.value]

  // æ„å»ºç±»ç›®ä¿¡æ¯
  const categoryInfo = {
    firstLevel: currentFirstLevelCategory?.name || '',
    secondLevel: currentSecondLevelCategory?.name || '',
    qualification: currentSecondLevelCategory?.qualification || '',
    scope: currentSecondLevelCategory?.scope || '',
    restrictions: currentSecondLevelCategory?.restrictions || ''
  }

  console.log('ç±»ç›®ä¿¡æ¯:', categoryInfo)

  // è·³è½¬åˆ°æ¨¡æ¿è¯¦æƒ…é¡µï¼Œä¼ é€’æ¨¡æ¿ä¿¡æ¯å’Œç±»ç›®ä¿¡æ¯
  uni.navigateTo({
    url: `/pages/template/detail/index?templateId=${program.id}&templateName=${encodeURIComponent(program.name)}&templateDesc=${encodeURIComponent(program.desc || '')}&templateIcon=${encodeURIComponent(program.icon || '')}&templatePrice=${program.price}&firstLevel=${encodeURIComponent(categoryInfo.firstLevel)}&secondLevel=${encodeURIComponent(categoryInfo.secondLevel)}&qualification=${encodeURIComponent(categoryInfo.qualification)}&scope=${encodeURIComponent(categoryInfo.scope)}&restrictions=${encodeURIComponent(categoryInfo.restrictions || '')}`
  })
}

// ========== é•¿æŒ‰ç›¸å…³ä»£ç ï¼ˆå·²æ³¨é‡Š - ä¿ç•™å¤‡ç”¨ï¼‰==========
/*
// ç‚¹å‡»å°ç¨‹åºå¡ç‰‡ï¼ˆåŸå‡½æ•°ï¼‰
const handleMiniProgramClick = (program: MiniProgram) => {
  console.log('ç‚¹å‡»å°ç¨‹åº:', program)
  // å¦‚æœèœå•æ­£åœ¨æ˜¾ç¤ºï¼Œä¸å¤„ç†ç‚¹å‡»
  if (showActionMenu.value) {
    hideActionMenu()
    return
  }
  uni.showToast({
    title: `æ‰“å¼€${program.name}`,
    icon: 'none'
  })
  // TODO: æ‰“å¼€å°ç¨‹åºæˆ–è·³è½¬åˆ°è¯¦æƒ…é¡µ
}

// å¡ç‰‡è§¦æ‘¸å¼€å§‹ï¼ˆç”¨äºæ£€æµ‹é•¿æŒ‰ï¼‰
const handleCardTouchStart = (event: any, program: MiniProgram) => {
  console.log('========== å¡ç‰‡è§¦æ‘¸å¼€å§‹ ==========')
  console.log('å°ç¨‹åº:', program.name)

  // æ¸…é™¤è¯¥å¡ç‰‡ä¹‹å‰çš„å®šæ—¶å™¨
  const cardId = program.id
  if (cardTouchTimers.value.has(cardId)) {
    clearTimeout(cardTouchTimers.value.get(cardId))
  }

  // 800msåè§¦å‘é•¿æŒ‰
  const timer = setTimeout(() => {
    console.log('========== è§¦å‘é•¿æŒ‰ ==========')
    console.log('é•¿æŒ‰çš„å°ç¨‹åº:', program.name)

    // è·å–è§¦æ‘¸ä½ç½®
    const touch = event.changedTouches?.[0] || event.touches?.[0]
    if (touch) {
      const x = touch.clientX || touch.x || 0
      const y = touch.clientY || touch.y || 0

      // è·å–ç³»ç»Ÿä¿¡æ¯ï¼ˆå±å¹•å®½åº¦ï¼‰
      const systemInfo = uni.getSystemInfoSync()
      const screenWidth = systemInfo.screenWidth || 375
      const screenHeight = systemInfo.screenHeight || 667

      // èœå•å®½åº¦ï¼ˆrpxè½¬pxï¼‰
      const menuWidth = 280 // èœå•å®½åº¦ rpx
      const rpxToPx = screenWidth / 750
      const menuWidthPx = menuWidth * rpxToPx

      // è®¡ç®—èœå•ä½ç½®ï¼Œç¡®ä¿ä¸è¶…å‡ºå±å¹•è¾¹ç•Œ
      let menuLeft = x - menuWidthPx / 2 // é»˜è®¤å±…ä¸­

      // å·¦è¾¹ç•Œæ£€æµ‹ï¼šèœå•ä¸èƒ½è¶…å‡ºå±å¹•å·¦ä¾§
      if (menuLeft < 20) {
        menuLeft = 20
      }

      // å³è¾¹ç•Œæ£€æµ‹ï¼šèœå•ä¸èƒ½è¶…å‡ºå±å¹•å³ä¾§
      if (menuLeft + menuWidthPx > screenWidth - 20) {
        menuLeft = screenWidth - menuWidthPx - 20
      }

      // ä¸Šè¾¹ç•Œæ£€æµ‹ï¼šèœå•ä¸èƒ½è¶…å‡ºå±å¹•é¡¶éƒ¨
      const menuHeightPx = 250 // ä¼°ç®—èœå•é«˜åº¦
      let menuTop = y - 100
      if (menuTop < 80) { // ç•™å‡ºé¡¶éƒ¨çŠ¶æ€æ ç©ºé—´
        menuTop = 80
      }

      // ä¸‹è¾¹ç•Œæ£€æµ‹ï¼šèœå•ä¸èƒ½è¶…å‡ºå±å¹•åº•éƒ¨
      if (menuTop + menuHeightPx > screenHeight - 20) {
        menuTop = screenHeight - menuHeightPx - 20
      }

      menuPosition.value = {
        top: menuTop,
        left: menuLeft
      }
      console.log('èœå•ä½ç½®:', menuPosition.value)
      console.log('å±å¹•å°ºå¯¸:', screenWidth, 'x', screenHeight)
    }

    selectedProgram.value = program
    showActionMenu.value = true

    // éœ‡åŠ¨åé¦ˆ
    uni.vibrateShort()
    console.log('========== é•¿æŒ‰å¤„ç†å®Œæˆ ==========')
  }, 800)

  cardTouchTimers.value.set(cardId, timer)
}

// å¡ç‰‡è§¦æ‘¸ç»“æŸï¼ˆå–æ¶ˆé•¿æŒ‰ï¼‰
const handleCardTouchEnd = (_event: any, program: MiniProgram) => {
  console.log('å¡ç‰‡è§¦æ‘¸ç»“æŸ:', program.name)

  // æ¸…é™¤è¯¥å¡ç‰‡çš„å®šæ—¶å™¨
  const cardId = program.id
  if (cardTouchTimers.value.has(cardId)) {
    clearTimeout(cardTouchTimers.value.get(cardId))
    cardTouchTimers.value.delete(cardId)
  }
}
*/

// é•¿æŒ‰å°ç¨‹åºå¡ç‰‡ï¼ˆä¿ç•™ç”¨äºç›´æ¥è°ƒç”¨ï¼‰
const handleMiniProgramLongPress = (program: MiniProgram, event: any) => {
  console.log('========== é•¿æŒ‰å°ç¨‹åºè§¦å‘ ==========')
  console.log('å°ç¨‹åºä¿¡æ¯:', program)
  console.log('äº‹ä»¶å¯¹è±¡:', event)

  // è·å–è§¦æ‘¸ä½ç½®
  const touch = event.changedTouches?.[0] || event.touches?.[0] || event.detail?.touches?.[0]
  console.log('è§¦æ‘¸ä½ç½®ä¿¡æ¯:', touch)

  if (touch) {
    const x = touch.clientX || touch.x || 0
    const y = touch.clientY || touch.y || 0
    menuPosition.value = {
      top: y - 100,
      left: x - 150
    }
    console.log('èœå•ä½ç½®è®¾ç½®:', menuPosition.value)
  }

  selectedProgram.value = program
  showActionMenu.value = true
  console.log('èœå•æ˜¾ç¤ºçŠ¶æ€:', showActionMenu.value)

  // éœ‡åŠ¨åé¦ˆ
  uni.vibrateShort()
  console.log('========== é•¿æŒ‰å¤„ç†å®Œæˆ ==========')
}

// éšè—èœå•
const hideActionMenu = () => {
  showActionMenu.value = false
  selectedProgram.value = null
}

// å¤„ç†èœå•æ“ä½œ
const handleMenuAction = (action: string) => {
  const program = selectedProgram.value
  if (!program) return

  console.log('èœå•æ“ä½œ:', action, program)

  switch (action) {
    case 'follow':
      // å…³æ³¨
      program.isFollowed = true
      uni.showToast({
        title: `å·²å…³æ³¨ ${program.name}`,
        icon: 'success'
      })
      // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
      saveFollowedPrograms()
      break

    case 'unfollow':
      // å–æ¶ˆå…³æ³¨
      program.isFollowed = false
      uni.showToast({
        title: `å·²å–æ¶ˆå…³æ³¨ ${program.name}`,
        icon: 'none'
      })
      saveFollowedPrograms()
      break

    case 'register':
      // æˆ‘è¦æ³¨å†Œ - æ£€æŸ¥ä¼ä¸šèµ„è´¨
      handleRegister(program)
      break

    case 'cooperate':
      // æˆ‘è¦åˆä½œ - æ£€æŸ¥åˆä½œä¿¡æ¯
      handleCooperate(program)
      break

    case 'rent':
      // æˆ‘è¦ç§Ÿèµ - æ£€æŸ¥ç§Ÿèµä¿¡æ¯
      handleRent(program)
      break
  }

  hideActionMenu()
}

// å¤„ç†æ³¨å†Œé€»è¾‘
const handleRegister = (program: MiniProgram) => {
  try {
    const saved = uni.getStorageSync('my_qualifications')
    if (!saved) {
      // æ²¡æœ‰ä¼ä¸šèµ„è´¨ï¼Œæç¤ºç”¨æˆ·å»å®Œå–„
      uni.showModal({
        title: 'æç¤º',
        content: 'æ³¨å†Œå°ç¨‹åºéœ€è¦å…ˆå®Œå–„ä¼ä¸šèµ„è´¨ä¿¡æ¯\n\næ˜¯å¦å‰å¾€"æˆ‘çš„"é¡µé¢æ·»åŠ èµ„è´¨ï¼Ÿ',
        confirmText: 'å‰å¾€',
        cancelText: 'å–æ¶ˆ',
        success: (res) => {
          if (res.confirm) {
            uni.switchTab({
              url: '/pages/profile/index-new'
            })
          }
        }
      })
      return
    }

    const qualifications = JSON.parse(saved) as any[]
    if (qualifications.length === 0) {
      uni.showModal({
        title: 'æç¤º',
        content: 'æ³¨å†Œå°ç¨‹åºéœ€è¦å…ˆå®Œå–„ä¼ä¸šèµ„è´¨ä¿¡æ¯\n\næ˜¯å¦å‰å¾€"æˆ‘çš„"é¡µé¢æ·»åŠ èµ„è´¨ï¼Ÿ',
        confirmText: 'å‰å¾€',
        cancelText: 'å–æ¶ˆ',
        success: (res) => {
          if (res.confirm) {
            uni.switchTab({
              url: '/pages/profile/index-new'
            })
          }
        }
      })
      return
    }

    if (qualifications.length === 1) {
      // åªæœ‰ä¸€ä¸ªèµ„è´¨ï¼Œç›´æ¥ä½¿ç”¨
      const company = qualifications[0]
      uni.showModal({
        title: 'ç¡®è®¤æ³¨å†Œ',
        content: `ä½¿ç”¨"${company.name}"æ³¨å†Œ${program.name}ï¼Ÿ`,
        success: (res) => {
          if (res.confirm) {
            // TODO: è°ƒç”¨æ³¨å†ŒAPI
            uni.showToast({
              title: 'æ³¨å†ŒæˆåŠŸ',
              icon: 'success'
            })
          }
        }
      })
    } else {
      // å¤šä¸ªèµ„è´¨ï¼Œå¼¹å‡ºé€‰æ‹©æ¡†
      const companyNames = qualifications.map(q => q.name)
      uni.showActionSheet({
        itemList: companyNames,
        success: (res) => {
          const selectedCompany = qualifications[res.tapIndex]
          uni.showModal({
            title: 'ç¡®è®¤æ³¨å†Œ',
            content: `ä½¿ç”¨"${selectedCompany.name}"æ³¨å†Œ${program.name}ï¼Ÿ`,
            success: (res2) => {
              if (res2.confirm) {
                // TODO: è°ƒç”¨æ³¨å†ŒAPI
                uni.showToast({
                  title: 'æ³¨å†ŒæˆåŠŸ',
                  icon: 'success'
                })
              }
            }
          })
        }
      })
    }
  } catch (e) {
    console.error('è¯»å–ä¼ä¸šèµ„è´¨å¤±è´¥:', e)
    uni.showToast({
      title: 'è¯»å–èµ„è´¨ä¿¡æ¯å¤±è´¥',
      icon: 'none'
    })
  }
}

// å¤„ç†åˆä½œé€»è¾‘
const handleCooperate = (program: MiniProgram) => {
  // è·³è½¬åˆ°åˆä½œç”³è¯·é¡µé¢ï¼Œå¹¶ä¼ é€’å°ç¨‹åºä¿¡æ¯
  const programData = encodeURIComponent(JSON.stringify(program))
  uni.navigateTo({
    url: `/pages/profile/cooperation-application?program=${programData}`
  })
}

// å¤„ç†ç§Ÿèµé€»è¾‘
const handleRent = (program: MiniProgram) => {
  // è·³è½¬åˆ°ç§Ÿèµç”³è¯·é¡µé¢ï¼Œå¹¶ä¼ é€’å°ç¨‹åºä¿¡æ¯
  const programData = encodeURIComponent(JSON.stringify(program))
  uni.navigateTo({
    url: `/pages/profile/leasing-application?program=${programData}`
  })
}

// ä¿å­˜å…³æ³¨çš„å°ç¨‹åºåˆ°æœ¬åœ°å­˜å‚¨
const saveFollowedPrograms = () => {
  const followed = allMiniPrograms.value.filter(p => p.isFollowed)
  uni.setStorageSync('followed_programs', JSON.stringify(followed.map(p => p.id)))
}

// ä»æœ¬åœ°å­˜å‚¨åŠ è½½å…³æ³¨çš„å°ç¨‹åº
const loadFollowedPrograms = () => {
  try {
    const saved = uni.getStorageSync('followed_programs_full')
    if (saved) {
      followedPrograms.value = JSON.parse(saved) as MiniProgram[]
      console.log('å·²å…³æ³¨çš„å°ç¨‹åº:', followedPrograms.value)
    } else {
      followedPrograms.value = []
    }
  } catch (e) {
    console.error('åŠ è½½å…³æ³¨åˆ—è¡¨å¤±è´¥:', e)
    followedPrograms.value = []
  }
}

// åˆ‡æ¢ä¸€çº§ç±»ç›®
const handleFirstLevelChange = (index: number) => {
  currentFirstLevel.value = index
  currentSecondLevel.value = 0
}

// åˆ‡æ¢äºŒçº§ç±»ç›®
const handleSecondLevelChange = (index: number) => {
  currentSecondLevel.value = index
  showSecondLevelMenu.value = false // é€‰æ‹©åå…³é—­é¢æ¿
}

// ç‚¹å‡»å¿«é€Ÿå…¥å£åº”ç”¨
const handleAppClick = (app: QuickEntryApp) => {
  uni.showToast({
    title: `æ‰“å¼€${app.name}`,
    icon: 'none'
  })
  // TODO: è·³è½¬åˆ°å¯¹åº”åº”ç”¨
}

// ç‚¹å‡»å°ç¨‹åºæµè§ˆæŒ‰é’®
const handleBrowseMiniPrograms = () => {
  uni.navigateTo({
    url: '/pages/mini-programs/browse'
  })
}

// å›¾ç‰‡åŠ è½½å¤±è´¥å¤„ç†
const handleImageError = (e: any, program: MiniProgram) => {
  console.warn('[å›¾æ ‡åŠ è½½å¤±è´¥]', program.name, 'icon:', program.icon)
}

// å›¾ç‰‡åŠ è½½æˆåŠŸå¤„ç†
const handleImageLoad = (e: any, program: MiniProgram) => {
  console.log('[å›¾æ ‡åŠ è½½æˆåŠŸ]', program.name)
}

// ç‚¹å‡»æ¨¡æ¿
const handleTemplateClick = (template: TemplateInfo) => {
  console.log('ç‚¹å‡»æ¨¡æ¿:', template)

  // è·å–å½“å‰äºŒçº§ç±»ç›®ä¿¡æ¯ï¼ˆåŒ…å«èµ„è´¨è¦æ±‚ï¼‰
  const currentSecondLevelCategory = currentSecondLevelCategories.value[currentSecondLevel.value]
  const currentFirstLevelCategory = currentCategories.value[currentFirstLevel.value]

  // æ„å»ºç±»ç›®ä¿¡æ¯
  const categoryInfo = {
    firstLevel: currentFirstLevelCategory?.name || '',
    secondLevel: currentSecondLevelCategory?.name || '',
    qualification: currentSecondLevelCategory?.qualification || '',
    scope: currentSecondLevelCategory?.scope || ''
  }

  console.log('ç±»ç›®ä¿¡æ¯:', categoryInfo)

  // ä¼ é€’æ¨¡æ¿åŸºæœ¬ä¿¡æ¯å’Œç±»ç›®ä¿¡æ¯åˆ°è¯¦æƒ…é¡µ
  uni.navigateTo({
    url: `/pages/template/detail/index?name=${encodeURIComponent(template.name)}&desc=${encodeURIComponent(template.desc)}&category=æ¨¡æ¿&userRole=merchant&firstLevel=${encodeURIComponent(categoryInfo.firstLevel)}&secondLevel=${encodeURIComponent(categoryInfo.secondLevel)}&qualification=${encodeURIComponent(categoryInfo.qualification)}&scope=${encodeURIComponent(categoryInfo.scope)}`
  })
}
</script>

<style scoped lang="scss">
.index-page {
  min-height: 100vh;
  background-color: #f5f5f5;
  padding-bottom: 120rpx;
}

// é¡µé¢æ•´ä½“åŒ…è£…å™¨
.page-wrapper {
  width: 100%;
  min-height: 100vh;
  background-color: #f5f5f5;
  box-sizing: border-box;
  position: relative;
  will-change: transform;
  // ä¸ºå›ºå®šå®šä½çš„é¡¶éƒ¨åŒºåŸŸç•™å‡ºç©ºé—´ï¼ˆåŒ…å«ï¼šæ ‡ç­¾æ ã€æœç´¢ã€å¿«é€Ÿå…¥å£ã€å¹¿å‘Šå­—å¹•ã€å°ç¨‹åºæµè§ˆï¼‰
  // å¢åŠ æ›´å¤šé—´è·ï¼Œç¡®ä¿å†…å®¹ä¸è¢«é®æŒ¡
  padding-top: 750rpx;
  transition: padding-top 0.3s ease;

  // å½“å¿«é€Ÿå…¥å£å±•å¼€æ—¶ï¼Œå¢åŠ é¡¶éƒ¨é—´è·
  &.quick-entry-expanded-mode {
    padding-top: 1520rpx; // 750rpx + 770rpx (å±•å¼€çš„å¿«é€Ÿå…¥å£é«˜åº¦)
  }
}

// é¡¶éƒ¨åŒºåŸŸå®¹å™¨ï¼ˆåŒ…å«æ©™è‰²å¯¼èˆªæ ã€æœç´¢æ¡†ã€å¿«é€Ÿå…¥å£ï¼‰
.top-area {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  width: 100%;
  z-index: 1000;
  background-color: #f5f5f5;
}

// ========== å°ç¨‹åºå®¹å™¨ç›¸å…³æ ·å¼ï¼ˆå·²æ³¨é‡Š - 2025-02-09ï¼‰ ==========
/*
// å°ç¨‹åºå®¹å™¨å¼¹çª—
.app-container-modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 9999;
  background-color: rgba(0, 0, 0, 0.75);
  transition: opacity 0.5s cubic-bezier(0.32, 0.72, 0, 1),
              background-color 0.5s cubic-bezier(0.32, 0.72, 0, 1),
              backdrop-filter 0.5s cubic-bezier(0.32, 0.72, 0, 1);
  visibility: visible;
  backdrop-filter: blur(20rpx);
  -webkit-backdrop-filter: blur(20rpx);

  &:not(.show) {
    pointer-events: none;
  }
}

// é€æ˜å…³é—­å±‚ï¼ˆz-index æœ€é«˜ï¼Œè¦†ç›–æ‰€æœ‰åŒºåŸŸï¼‰
.modal-close-layer {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 999;
}

.app-container-content {
  position: relative;
  z-index: 1;
  width: 100%;
  max-height: 100%;
  background: transparent; // é€æ˜èƒŒæ™¯
  padding: 0 30rpx;
  overflow-y: auto;
  transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  will-change: transform;
  pointer-events: none; // è®©æ•´ä¸ªå†…å®¹åŒºåŸŸä¸å“åº”ç‚¹å‡»
}

// å¯äº¤äº’å…ƒç´ éœ€è¦æå‡å±‚çº§å¹¶å¯ç”¨ç‚¹å‡»
.app-item,
.app-search-bar,
.section-header,
.section-action,
.discover-card,
.bottom-tip {
  position: relative;
  z-index: 1000;
  pointer-events: auto; // è¿™äº›å…ƒç´ å¯ä»¥å“åº”ç‚¹å‡»
}

// é¡¶éƒ¨æœç´¢æ 
.app-search-bar {
  padding: 30rpx 0;
  position: sticky;
  top: 0;
  background: transparent;
  z-index: 10;
}

.search-input-wrapper {
  display: flex;
  align-items: center;
  height: 72rpx;
  background-color: #ffffff;
  border-radius: 36rpx;
  padding: 0 30rpx;
  box-shadow: 0 2rpx 8rpx rgba(0, 0, 0, 0.08);

  .search-icon {
    font-size: 32rpx;
    margin-right: 12rpx;
  }

  .search-input {
    flex: 1;
    font-size: 28rpx;
    color: #333;
  }
}

// å°ç¨‹åºåŒºå—
.app-section {
  margin-bottom: 40rpx;

  &.discover-section {
    margin-bottom: 20rpx;
  }
}

.section-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 24rpx;
  padding: 0 10rpx;
}

.section-title {
  font-size: 32rpx;
  font-weight: bold;
  color: #ffffff; // ç™½è‰²æ–‡å­—
}

.section-action {
  display: flex;
  align-items: center;
  font-size: 26rpx;
  color: rgba(255, 255, 255, 0.8); // åŠé€æ˜ç™½è‰²

  .action-icon {
    margin-left: 4rpx;
  }

  .action-text {
    margin-right: 4rpx;
  }
}

// å°ç¨‹åºç½‘æ ¼
.app-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 30rpx 20rpx;
}

.app-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 16rpx;
  border-radius: 16rpx;
  transition: all 0.3s;
  background-color: rgba(255, 255, 255, 0.15); // åŠé€æ˜ç™½è‰²èƒŒæ™¯
  backdrop-filter: blur(20rpx); // æ¯›ç»ç’ƒæ•ˆæœ
  border: 1rpx solid rgba(255, 255, 255, 0.1); // æ·»åŠ è¾¹æ¡†è®©å¡ç‰‡æ›´æ¸…æ™°

  &:active {
    background-color: rgba(255, 255, 255, 0.25);
    transform: scale(0.95);
  }

  .app-icon {
    width: 96rpx;
    height: 96rpx;
    margin-bottom: 12rpx;
    border-radius: 20rpx;
    overflow: hidden;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;

    .app-icon-image {
      width: 100%;
      height: 100%;
    }

    .app-emoji {
      font-size: 56rpx;
    }
  }

  .app-name-text {
    font-size: 24rpx;
    color: #ffffff; // ç™½è‰²æ–‡å­—
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
  }
}

// å‘ç°å¡ç‰‡
.discover-card {
  display: flex;
  align-items: center;
  padding: 30rpx;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 20rpx;
  box-shadow: 0 4rpx 12rpx rgba(102, 126, 234, 0.3);

  .discover-icon {
    width: 80rpx;
    height: 80rpx;
    font-size: 48rpx;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 20rpx;
  }

  .discover-content {
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  .discover-title {
    font-size: 32rpx;
    font-weight: bold;
    color: #ffffff;
    margin-bottom: 8rpx;
  }

  .discover-desc {
    font-size: 24rpx;
    color: rgba(255, 255, 255, 0.8);
  }
}

// åº•éƒ¨æç¤º
.bottom-tip {
  padding: 40rpx 0;
  text-align: center;

  .tip-text {
    font-size: 24rpx;
    color: rgba(255, 255, 255, 0.6); // åŠé€æ˜ç™½è‰²
  }
}

// ä¸‹æ‹‰è¿›åº¦æŒ‡ç¤ºå™¨ï¼ˆå¾®ä¿¡é£æ ¼ï¼‰
.pull-down-indicator {
  position: fixed;
  top: 550rpx; // åœ¨å¿«é€Ÿå…¥å£å®¹å™¨å’Œä¸€çº§ç±»ç›®æ ‡ç­¾ä¸‹æ–¹
  left: 50%;
  z-index: 9998;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  transition: all 0.3s cubic-bezier(0.32, 0.72, 0, 1);
  pointer-events: none; // ç¡®ä¿ä¸ä¼šé˜»æŒ¡è§¦æ‘¸äº‹ä»¶
}

// æ¨¡ç³ŠèƒŒæ™¯å±‚ï¼ˆä¸‹æ‹‰æ—¶æ˜¾ç¤ºï¼‰
.blur-background {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 9997;
  background-color: rgba(0, 0, 0, 0.75);
  backdrop-filter: blur(20rpx);
  -webkit-backdrop-filter: blur(20rpx);
  pointer-events: none; // ç¡®ä¿ä¸ä¼šé˜»æŒ¡è§¦æ‘¸äº‹ä»¶
  transition: opacity 0.3s cubic-bezier(0.32, 0.72, 0, 1);
}

.pull-down-indicator {
  .indicator-circle {
    width: 120rpx;
    height: 120rpx;
    border-radius: 50%;
    border: 4rpx solid rgba(0, 0, 0, 0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #ffffff;
    box-shadow: 0 4rpx 16rpx rgba(0, 0, 0, 0.1);
    margin-bottom: 20rpx;
    transition: all 0.4s cubic-bezier(0.32, 0.72, 0, 1);

    .indicator-icon {
      font-size: 56rpx;
      font-weight: 300;
      transition: color 0.4s cubic-bezier(0.32, 0.72, 0, 1);
    }
  }

  .indicator-text {
    font-size: 28rpx;
    font-weight: 500;
    letter-spacing: 1rpx;
    transition: color 0.4s cubic-bezier(0.32, 0.72, 0, 1);
  }
}
*/
// ========== å°ç¨‹åºå®¹å™¨ç›¸å…³æ ·å¼ç»“æŸ ==========

// æœç´¢æ¡†åŒºåŸŸï¼ˆé€æ˜èƒŒæ™¯ï¼‰
.search-container {
  background: transparent;
  padding: 20rpx 30rpx;

  .search-box {
    display: flex;
    align-items: center;
    height: 64rpx;
    background-color: #ffffff;
    border-radius: 32rpx;
    padding: 0 24rpx;
    gap: 12rpx;

    .scan-icon {
      font-size: 32rpx;
      color: #999;
    }

    .search-input {
      flex: 1;
      font-size: 28rpx;
      color: #333;
    }

    .camera-icon {
      font-size: 32rpx;
      color: #999;
    }

    .search-btn {
      padding: 8rpx 20rpx;
      background: linear-gradient(135deg, #ff9500 0%, #ff6a00 100%);
      color: #ffffff;
      font-size: 26rpx;
      border-radius: 20rpx;
      font-weight: 500;
    }
  }
}

// å¿«é€Ÿå…¥å£ - æ¨ªå‘æ»‘åŠ¨çš„Logoå¡ç‰‡
.quick-entry-container {
  background-color: #ffffff;
  padding: 30rpx 0;
  margin-bottom: 0;

  .quick-entry-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 30rpx;
    margin-bottom: 20rpx;

    .section-title {
      font-size: 32rpx;
      font-weight: 600;
      color: #333;
    }

    .more-btn {
      display: flex;
      align-items: center;
      padding: 8rpx 16rpx;
      border-radius: 20rpx;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
      border: 1rpx solid #667eea;

      .more-text {
        font-size: 26rpx;
        color: #667eea;
        margin-right: 6rpx;
      }

      .more-icon {
        font-size: 28rpx;
        color: #667eea;
      }

      &:active {
        opacity: 0.7;
      }
    }
  }

  .quick-entry-scroll {
    display: flex;
    white-space: nowrap;
    overflow-x: auto;
    overflow-y: hidden;
    padding: 0 30rpx;
    gap: 20rpx;
    -webkit-overflow-scrolling: touch;

    &::-webkit-scrollbar {
      display: none;
    }

    .app-card {
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      padding: 20rpx;
      min-width: 160rpx;
      border-radius: 16rpx;
      background: linear-gradient(135deg, #f5f7fa 0%, #ffffff 100%);
      box-shadow: 0 2rpx 8rpx rgba(0, 0, 0, 0.04);
      transition: all 0.3s;

      &:active {
        transform: scale(0.95);
        box-shadow: 0 2rpx 6rpx rgba(0, 0, 0, 0.08);
      }

      .app-icon {
        width: 96rpx;
        height: 96rpx;
        margin-bottom: 12rpx;
        border-radius: 20rpx;
        overflow: hidden;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;

        .app-icon-image {
          width: 100%;
          height: 100%;
        }

        .app-emoji {
          font-size: 56rpx;
        }
      }

      .app-name {
        font-size: 24rpx;
        font-weight: 500;
        color: #333;
        text-align: center;
      }
    }
  }

  // å±•å¼€æ¨¡å¼ - ç«–å‘æ»šåŠ¨çš„ç½‘æ ¼è§†å›¾
  .quick-entry-expanded {
    max-height: 800rpx; // æœ€å¤§é«˜åº¦ï¼Œè¶…è¿‡åå¯æ»šåŠ¨
    padding: 0 30rpx;

    .app-grid-expanded {
      display: grid;
      grid-template-columns: repeat(4, 1fr); // 4åˆ—å¸ƒå±€
      gap: 20rpx;
      padding-bottom: 20rpx;

      .app-card-expanded {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20rpx 12rpx;
        border-radius: 16rpx;
        background: linear-gradient(135deg, #f5f7fa 0%, #ffffff 100%);
        box-shadow: 0 2rpx 8rpx rgba(0, 0, 0, 0.04);
        transition: all 0.3s;

        &:active {
          transform: scale(0.95);
          box-shadow: 0 2rpx 6rpx rgba(0, 0, 0, 0.08);
        }

        .app-icon {
          width: 96rpx;
          height: 96rpx;
          margin-bottom: 12rpx;
          border-radius: 20rpx;
          overflow: hidden;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          display: flex;
          align-items: center;
          justify-content: center;

          .app-icon-image {
            width: 100%;
            height: 100%;
          }

          .app-emoji {
            font-size: 56rpx;
          }
        }

        .app-name {
          font-size: 22rpx;
          font-weight: 500;
          color: #333;
          text-align: center;
          overflow: hidden;
          text-overflow: ellipsis;
          white-space: nowrap;
          width: 100%;
        }
      }
    }
  }
}

// é¡¶éƒ¨å›ºå®šåŒºåŸŸå®¹å™¨ï¼ˆåŒ…å«æ ‡ç­¾æ ã€æœç´¢æ¡†ã€å¿«é€Ÿå…¥å£ï¼Œæ•´ä¸ªåŒºåŸŸéƒ½å¯ä»¥ä¸‹æ‹‰è§¦å‘å°ç¨‹åºï¼‰
.top-fixed-area {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 1000;
  background-color: #f5f5f5; // æ·»åŠ èƒŒæ™¯è‰²ï¼Œé¿å…é€æ˜å¯¼è‡´çœ‹åˆ°ä¸‹æ–¹å†…å®¹
}

// é¡¶éƒ¨æ¨ªå‘æ ‡ç­¾æ ï¼ˆæ·˜å®é£æ ¼ï¼Œæµ…æ©™è‰²æ¸å˜èƒŒæ™¯ï¼‰
.top-tabs-container {
  background: linear-gradient(90deg, #ff9500 0%, #ff6a00 100%);

  .top-tabs-scroll {
    width: 100%;
    white-space: nowrap;
  }

  .top-tabs-wrapper {
    display: inline-flex;
    padding: 10rpx 30rpx;
    gap: 10rpx;
  }

  .top-tab-item {
    position: relative;
    flex-shrink: 0;
    padding: 16rpx 28rpx;
    display: inline-flex;
    flex-direction: column;
    align-items: center;
    border-radius: 8rpx;
    transition: all 0.3s;
    margin-bottom: 0; // ç¡®ä¿è´´åº•

    .tab-text {
      font-size: 32rpx;
      color: rgba(255, 255, 255, 0.8);
      white-space: nowrap;
    }

    &.active {
      background-color: #ffffff;
      border-radius: 8rpx;
      box-shadow: 0 2rpx 8rpx rgba(255, 106, 0, 0.15);

      .tab-text {
        color: #ff6a00;
        font-weight: bold;
      }
    }

    .tab-underline {
      display: none; // æ”¹ç”¨ç™½è‰²èƒŒæ™¯ï¼Œä¸éœ€è¦ä¸‹åˆ’çº¿äº†
    }
  }
}

// å¹¿å‘Šå­—å¹•è½®æ’­ï¼ˆæ›¿æ¢åŸä¸€çº§ç±»ç›®æ¨ªå‘æ ‡ç­¾ï¼‰
.ad-ticker {
  background-color: #fff9e6;
  border-bottom: 1rpx solid #ffe58f;
  height: 64rpx;
  overflow: hidden;
  position: relative;

  .ticker-content {
    height: 100%;
    display: flex;
    align-items: center;
    padding: 0 30rpx;
  }

  .ticker-scroll {
    width: 100%;
    overflow: hidden;
  }

  .ticker-text {
    font-size: 26rpx;
    color: #ff6a00;
    white-space: nowrap;
    display: inline-block;
    animation: tickerScroll 15s linear infinite;

    &::after {
      content: '     â€¢     ';
      margin: 0 30rpx;
    }
  }

  @keyframes tickerScroll {
    0% {
      transform: translateX(100%);
    }
    100% {
      transform: translateX(-100%);
    }
  }
}

// å°ç¨‹åºæµè§ˆå…¥å£
.mini-program-browse {
  background-color: #ffffff;
  padding: 24rpx 30rpx;
  border-bottom: 1rpx solid #f0f0f0;

  .browse-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .browse-title {
    font-size: 32rpx;
    font-weight: 600;
    color: #333;
  }

  .browse-btn {
    display: flex;
    align-items: center;
    padding: 8rpx 20rpx;
    border-radius: 20rpx;
    background: linear-gradient(135deg, #ff9500 0%, #ff6a00 100%);

    .browse-text {
      font-size: 26rpx;
      color: #ffffff;
      margin-right: 6rpx;
    }

    .browse-arrow {
      font-size: 28rpx;
      color: #ffffff;
      font-weight: bold;
    }

    &:active {
      opacity: 0.8;
      transform: scale(0.95);
    }
  }
}

// ä¸»å†…å®¹åŒºåŸŸ
.content-container {
  position: relative;
  display: flex;
  height: calc(100vh - 520rpx);
}

// å·¦ä¾§æ‚¬æµ®è§¦å‘æŒ‰é’®ï¼ˆç›¸å¯¹äºcontent-containerå®šä½ï¼‰
.floating-trigger {
  position: absolute;
  left: 0;
  top: 50%;
  transform: translateY(-50%);
  z-index: 100;
  display: flex;
  align-items: center;
  background-color: #ffffff;
  border: 1rpx solid #e0e0e0;
  border-left: none;
  border-radius: 0 16rpx 16rpx 0;
  padding: 16rpx 8rpx;
  box-shadow: 2rpx 0 8rpx rgba(0, 0, 0, 0.1);
  transition: transform 0.3s;

  // å½“äºŒçº§èœå•æ‰“å¼€æ—¶ï¼Œè·Ÿéšèœå•å‘å³ç§»åŠ¨
  &.menu-open {
    transform: translateY(-50%) translateX(180rpx);
  }

  &:active {
    transform: translateY(-50%) scale(0.95);

    &.menu-open {
      transform: translateY(-50%) translateX(180rpx) scale(0.95);
    }
  }

  .trigger-icon {
    font-size: 28rpx;
    color: #666;
    font-weight: bold;
  }
}

// äºŒçº§ç±»ç›®å¼¹å‡ºé¢æ¿ï¼ˆç›¸å¯¹äºcontent-containerå®šä½ï¼‰
.second-level-panel {
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  width: 180rpx;
  z-index: 99;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s;

  &.show {
    opacity: 1;
    visibility: visible;
  }

  .panel-content {
    width: 180rpx;
    height: 100%;
    background-color: #f8f8f8;
    display: flex;
    flex-direction: column;
    transform: translateX(-100%);
    transition: transform 0.3s;
  }

  &.show .panel-content {
    transform: translateX(0);
  }

  .panel-scroll {
    flex: 1;
    overflow-y: auto;
  }

  .panel-item {
    padding: 32rpx 20rpx;
    font-size: 26rpx;
    color: #666;
    text-align: center;
    border-left: 4rpx solid transparent;
    transition: all 0.3s;

    &.active {
      background-color: #ffffff;
      color: #333;
      font-weight: bold;
      border-left-color: #667eea;
    }
  }
}

// å³ä¾§ä¸»å†…å®¹ï¼ˆå¸¦åŠ¨ç”»çš„margin-leftï¼‰
.main-content {
  width: 100%;
  margin-left: 0;
  transition: margin-left 0.3s;
  background-color: #ffffff;

  &.shift-right {
    margin-left: 180rpx;
  }

  .content-scroll {
    height: 100%;
    padding: 30rpx;
  }

  .category-title {
    font-size: 32rpx;
    font-weight: bold;
    color: #333;
    margin-bottom: 30rpx;
  }

  .template-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20rpx;

    .template-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 30rpx 20rpx;
      border-radius: 16rpx;
      background: linear-gradient(135deg, #f5f7fa 0%, #ffffff 100%);
      box-shadow: 0 2rpx 8rpx rgba(0, 0, 0, 0.04);
      transition: all 0.3s;

      &:active {
        transform: scale(0.95);
        box-shadow: 0 2rpx 6rpx rgba(0, 0, 0, 0.08);
      }

      .template-icon {
        width: 80rpx;
        height: 80rpx;
        margin-bottom: 16rpx;
        border-radius: 16rpx;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        box-shadow: 0 2rpx 8rpx rgba(0, 0, 0, 0.06);
        overflow: hidden;

        .template-emoji {
          font-size: 48rpx;
        }
      }

      .template-name {
        font-size: 26rpx;
        font-weight: 500;
        color: #333;
        margin-bottom: 8rpx;
        text-align: center;
      }

      .template-desc {
        font-size: 22rpx;
        color: #999;
        text-align: center;
      }
    }
  }

  // å°ç¨‹åºå¡ç‰‡ç½‘æ ¼ï¼ˆæ–°æ ·å¼ï¼‰
  .mini-program-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20rpx;
    padding-bottom: 40rpx;

    .mini-program-card {
      background: #ffffff;
      border-radius: 20rpx;
      padding: 24rpx 16rpx;
      display: flex;
      flex-direction: column;
      align-items: center;
      box-shadow: 0 4rpx 16rpx rgba(0, 0, 0, 0.06);
      transition: all 0.3s;
      position: relative;

      &:active {
        transform: scale(0.95);
        box-shadow: 0 2rpx 12rpx rgba(0, 0, 0, 0.08);
      }

      .program-icon-wrapper {
        width: 96rpx;
        height: 96rpx;
        border-radius: 20rpx;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        margin-bottom: 16rpx;
        position: relative;
        overflow: hidden;
        box-shadow: 0 4rpx 12rpx rgba(102, 126, 234, 0.3);

        .program-icon {
          width: 100%;
          height: 100%;
        }

        .program-emoji {
          font-size: 56rpx;
        }

        .follow-badge {
          position: absolute;
          top: 4rpx;
          right: 4rpx;
          font-size: 20rpx;
          background: rgba(255, 255, 255, 0.95);
          border-radius: 50%;
          width: 32rpx;
          height: 32rpx;
          display: flex;
          align-items: center;
          justify-content: center;
          box-shadow: 0 2rpx 6rpx rgba(0, 0, 0, 0.1);
        }
      }

      .program-name {
        font-size: 26rpx;
        font-weight: 500;
        color: #333;
        margin-bottom: 8rpx;
        text-align: center;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        width: 100%;
      }

      .program-price-row {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4rpx;
      }

      .program-price {
        font-size: 28rpx;
        font-weight: 600;
        color: #ff5722;
        text-align: center;
      }

      .program-price-dou {
        font-size: 22rpx;
        color: #999;
        text-align: center;
      }
    }
  }

  // é•¿æŒ‰å¼¹å‡ºèœå•
  .action-menu-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.4);
    z-index: 9999;
  }

  .action-menu {
    position: fixed;
    background: #ffffff;
    border-radius: 20rpx;
    padding: 12rpx 0;
    min-width: 280rpx;
    box-shadow: 0 8rpx 32rpx rgba(0, 0, 0, 0.15);
    z-index: 10000;
    animation: menuSlideIn 0.2s ease-out;

    .menu-item {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 28rpx 32rpx;
      transition: background 0.2s;

      &:active {
        background: #f5f5f5;
      }

      &:not(:last-child) {
        border-bottom: 1rpx solid #f0f0f0;
      }

      .menu-text {
        font-size: 30rpx;
        color: #333;
        font-weight: 500;
      }
    }
  }

  @keyframes menuSlideIn {
    from {
      opacity: 0;
      transform: scale(0.9) translateY(-20rpx);
    }
    to {
      opacity: 1;
      transform: scale(1) translateY(0);
    }
  }
}
</style>
