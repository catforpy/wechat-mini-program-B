# 会都销售 App 开发手册

> 项目名称：唐极课得
> 版本：1.0.0
> 开发框架：uni-app + Vue 3 + TypeScript
> 目标平台：Android/iOS 原生 App

---

## 📋 目录

1. [项目概述](#项目概述)
2. [横竖屏锁定](#横竖屏锁定)
3. [下拉手势优化](#下拉手势优化)
4. [云打包注意事项](#云打包注意事项)
5. [关键技术实现](#关键技术实现)
6. [已解决问题](#已解决问题)
7. [开发规范](#开发规范)

---

## 项目概述

### 项目信息

- **应用名称**：唐极课得
- **应用类型**：商户端小程序
- **开发工具**：HBuilderX
- **应用ID**：__UNI__1D08B00
- **Vue版本**：3

### 项目结构

```
会都销售app/
├── App.vue                    # 应用主入口
├── main.js                    # 主入口文件
├── manifest.json              # 应用配置文件
├── pages.json                 # 页面路由配置
├── index.html                 # HTML入口（H5）
├── pages/
│   ├── index/                 # 首页
│   │   └── index.vue         # 下拉手势+抽纸效果
│   ├── login/                # 登录页
│   ├── video/                # 视频页
│   ├── message/              # 消息页
│   ├── live/                 # 直播页
│   ├── profile/              # 我的
│   ├── template/             # 模板相关
│   └── order/                # 订单相关
├── static/                   # 静态资源
├── stores/                   # 状态管理
└── data/                     # 数据文件
```

---

## 横竖屏锁定

### 问题描述

在 Android/iOS 原生 App 中，需要强制锁定为竖屏显示，不允许用户旋转屏幕切换到横屏。

### 解决方案

#### 1. manifest.json 配置

**App 全局配置**（第13行）：
```json
"app-plus" : {
    "screenOrientation" : ["portrait-primary"],
    ...
}
```

**Android 配置**（第42-43行）：
```json
"android" : {
    "screenOrientation" : "portrait",
    "gravityThemes" : "top"
}
```

**iOS 配置**（第47行）：
```json
"ios" : {
    "screenOrientation" : ["UIInterfaceOrientationPortrait"]
}
```

#### 2. pages.json 配置

每个页面都需要配置：
```json
{
    "path": "pages/index/index",
    "style": {
        "pageOrientation": "portrait"
    }
}
```

#### 3. 代码强制锁定（App.vue）

**HTML5+ API 锁定**（第57-75行）：
```javascript
// 使用 HTML5+ API 强制锁定屏幕方向
// @ts-ignore
if (typeof plus !== 'undefined' && plus.screen && plus.screen.lockOrientation) {
  try {
    // 锁定为竖屏（正向）
    plus.screen.lockOrientation('portrait-primary')
    console.log('[屏幕方向] ✅ 已调用 plus.screen.lockOrientation("portrait-primary")')

    // 验证是否锁定成功
    // @ts-ignore
    const currentOrientation = plus.screen.orientation
    console.log('[屏幕方向] 当前屏幕方向:', currentOrientation)
  } catch (error) {
    console.error('[屏幕方向] ❌ 锁定屏幕方向失败:', error)
  }
}
```

**监听窗口变化并重新锁定**（第77-101行）：
```javascript
uni.onWindowResize && uni.onWindowResize((res) => {
  const newIsLandscape = res.size.windowWidth > res.size.windowHeight

  if (newIsLandscape) {
    console.log('[屏幕方向] ⚠️⚠️⚠️ 检测到横屏,尝试强制切换回竖屏')
    // 重新锁定
    // @ts-ignore
    if (typeof plus !== 'undefined' && plus.screen && plus.screen.lockOrientation) {
      plus.screen.lockOrientation('portrait-primary')
      console.log('[屏幕方向] ✅ 已重新锁定竖屏')
    }
  }
})
```

### 重要提示

⚠️ **必须使用自定义调试基座**

标准调试基座不会应用 manifest.json 中的配置，需要制作自定义调试基座：
1. 在 HBuilderX 中：运行 → 运行到手机或模拟器 → 制作自定义调试基座
2. 选择云打包或本地打包
3. 制作完成后，运行时选择自定义调试基座

---

## 下拉手势优化

### 功能需求

实现微信小程序容器的下拉手势，具有以下特点：
1. **抽纸效果**：首页向下滑出的同时，小程序容器从上方滑入
2. **阻尼效果**：手指滑动距离和下拉距离基本匹配，增加粘滞性
3. **触发阈值**：下拉到 50% 时触发显示小程序容器
4. **反向手势**：小程序容器显示时，上滑可以关闭

### 实现细节

#### 1. 下拉阻尼算法

**阻尼公式**（pages/index/index.vue 第463-469行）：
```javascript
// 使用更强的阻尼效果：手指滑动距离和下拉距离要基本匹配
// 前40%是1:1，40%之后使用更小的阻尼系数(增加粘滞性)
let dampenedDeltaY = deltaY
if (deltaY > PULL_THRESHOLD.value * 0.4) {
    const excess = deltaY - PULL_THRESHOLD.value * 0.4
    dampenedDeltaY = PULL_THRESHOLD.value * 0.4 + excess * 0.3
}
```

- **前40%**：1:1 跟随手指
- **40%之后**：使用 0.3 的阻尼系数，增加阻力
- 这样可以避免手指稍微滑动就下拉半个屏幕

#### 2. 抽纸动画

**首页向下移动**（第6行）：
```vue
:style="{ transform: `translateY(${pullDownProgress * 100}%)`, ... }"
```

**小程序容器从上方滑入**（第206行）：
```vue
transform: `translateY(-${100 * (1 - pullDownProgress * 0.6)}%)`
```

- `pullDownProgress` 从 0 到 1
- 首页：translateY(0%) → translateY(100%)
- 小程序容器：translateY(-100%) → translateY(0%)
- 速度系数 0.6 避免小程序容器滑入过快

#### 3. 透明度渐变

**背景层**（第193-196行）：
```vue
backgroundColor: showAppContainer ? 'rgba(0, 0, 0, 0.75)' : `rgba(0, 0, 0, ${pullDownProgress * 0.75})`
opacity: showAppContainer ? 1 : pullDownProgress
backdropFilter: showAppContainer || pullDownProgress > 0.5 ? 'blur(20rpx)' : 'none'
```

**内容层**（第207行）：
```vue
opacity: showAppContainer ? 1 : pullDownProgress
```

- 下拉时：透明度从 0 逐渐变为 1
- 显示后：保持完全显示
- 背景模糊在 50% 时逐渐出现

#### 4. 触发阈值

**触发显示**（第515行）：
```javascript
if (pullDownProgress.value >= 0.5) {
    showAppContainer.value = true
    pullDownProgress.value = 1
}
```

**触发关闭**（第493行）：
```javascript
if (isSwipingUpToClose.value && pullDownProgress.value <= 0.5) {
    hideAppContainer()
}
```

#### 5. 方向锁定

防止横向滚动触发下拉：
```javascript
const DIRECTION_LOCK_THRESHOLD = 10 // 方向锁定阈值（px）

if (!touchDirection) {
    if (deltaX > DIRECTION_LOCK_THRESHOLD || Math.abs(deltaY) > DIRECTION_LOCK_THRESHOLD) {
        touchDirection = deltaX > Math.abs(deltaY) ? 'horizontal' : 'vertical'
    }
}

if (touchDirection === 'horizontal') {
    return // 锁定为横向滑动，不处理下拉
}
```

#### 6. 上滑关闭手势

**触摸开始**（第405-411行）：
```javascript
if (showAppContainer.value) {
    isSwipingUpToClose.value = false
    swipeUpStartX = e.touches[0].clientX
    swipeUpStartY = e.touches[0].clientY
    touchDirection = null
    return
}
```

**触摸移动**（第431-471行）：
```javascript
// 只处理向上滑动（deltaY < 0）
if (deltaY < 0) {
    isSwipingUpToClose.value = true
    const absDeltaY = Math.abs(deltaY)
    // 计算反向进度 (从1递减到0)
    const progress = Math.max(0, Math.min(1 - dampenedDeltaY / threshold, 1))
    pullDownProgress.value = progress
}
```

**触摸结束**（第486-503行）：
```javascript
if (isSwipingUpToClose.value && pullDownProgress.value <= 0.5) {
    hideAppContainer()
} else {
    pullDownProgress.value = 1 // 恢复显示
}
```

### 动画曲线

使用 `cubic-bezier(0.25, 0.46, 0.45, 0.94)` 实现有阻尼感的动画：
```vue
transition: 'transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94)'
```

---

## 云打包注意事项

### ⚠️ 文件命名规范

云打包**不支持中文文件名**，必须使用英文或拼音。

### 已修复的文件

| 原文件名 | 新文件名 | 位置 |
|---------|---------|------|
| 会都.jpg | haidu.jpg | /static/ |
| 达管.png | daguan.png | /static/ |
| 都达.png | douda.png | /static/ |
| 金达.jpg | jinda.jpg | /static/ |
| 营业执照.jpg | business-license.jpg | /static/ |
| 背景图001.png | background-001.png | /static/ |
| 法人身份证正面.png | legal-person-id-front.png | /static/ |
| 法人身份证反面.png | legal-person-id-back.png | /static/ |
| 网络文化经营许可证.png | network-culture-license.png | /static/ |

### 云打包前检查清单

- [ ] 确认所有静态资源文件名都是英文
- [ ] 清理 `unpackage/dist/build` 目录
- [ ] 检查 manifest.json 配置是否正确
- [ ] 确认自定义调试基座已制作
- [ ] 检查代码中所有文件引用路径

---

## 关键技术实现

### 1. 触摸事件处理

使用 `.capture` 修饰符在捕获阶段处理触摸事件：
```vue
@touchstart.capture="handlePageTouchStart"
@touchmove.capture="handlePageTouchMove"
@touchend.capture="handlePageTouchEnd"
```

### 2. 滚动区域检测

检测触摸是否在可滚动区域内，避免冲突：
```javascript
const isTouchInScrollableArea = (e: any): boolean => {
    const scrollableClasses = [
        'panel-scroll',      // 二级菜单滚动
        'content-scroll',     // 三级内容滚动
        'top-tabs-scroll',    // 顶部标签滚动
        'tabs-scroll',        // 一级类目标签滚动
        'quick-entry-scroll', // 快速入口滚动
        ...
    ]
    // 递归检查父元素的 class
    ...
}
```

### 3. 页面顶部检测

只在页面顶部时允许下拉：
```javascript
const handleMainContentScroll = (e: any) => {
    const scrollTop = e.detail.scrollTop
    isAtPageTop.value = scrollTop <= 0
}

// 触摸移动时检查
if (!isAtPageTop.value || deltaY <= 0) {
    return // 不在顶部或向上滑动，不处理下拉
}
```

### 4. 性能优化

使用 `will-change` 提示浏览器优化：
```scss
.page-wrapper {
    will-change: transform;
}
```

### 5. 状态管理

使用 Vue 3 Composition API：
```javascript
const showAppContainer = ref(false)
const pullDownProgress = ref(0)
const isSwipingUpToClose = ref(false)
```

---

## 已解决问题

### 问题1：横竖屏切换失败

**现象**：应用在手机上可以切换到横屏

**原因**：
1. 使用了标准调试基座，不应用 manifest.json 配置
2. 缺少代码级别的强制锁定

**解决方案**：
1. 制作自定义调试基座
2. 在 App.vue 中添加 `plus.screen.lockOrientation()` 调用
3. 监听窗口变化并重新锁定

### 问题2：下拉速度过快

**现象**：手指稍微滑动一点，下拉速度就已经快半个屏幕

**原因**：阻尼系数过大（0.5）

**解决方案**：降低阻尼系数到 0.3，调整阻尼触发点到 40%

### 问题3：小程序容器滑入过快

**现象**：小程序容器的滑出速度远超首页滑出的速度，出现叠加

**原因**：小程序容器的 translateY 变化速度和首页不一致

**解决方案**：给小程序容器的滑入速度乘以 0.6 的系数

### 问题4：云打包失败

**现象**：云打包时报错，提示中文文件名

**原因**：云打包不支持中文文件名

**解决方案**：重命名所有静态资源文件为英文

---

## 开发规范

### 命名规范

1. **文件命名**：只能使用英文、数字、下划线、连字符
2. **变量命名**：驼峰命名法（camelCase）
3. **常量命名**：全大写下划线分隔（UPPER_SNAKE_CASE）
4. **组件命名**：帕斯卡命名法（PascalCase）

### 注释规范

```javascript
/**
 * 函数功能描述
 * @param {类型} 参数名 - 参数说明
 * @returns {类型} 返回值说明
 */
const functionName = (param: Type) => {
    // 实现代码
}
```

### Git 提交规范

```
<type>(<scope>): <subject>

<body>

<footer>
```

**类型（type）：**
- feat：新功能
- fix：修复 bug
- docs：文档更新
- style：代码格式调整
- refactor：重构
- test：测试相关
- chore：构建过程或辅助工具的变动

**示例：**
```
feat(手势): 优化下拉手势阻尼效果

- 降低阻尼系数从0.5到0.3
- 调整触发阈值从80%到50%
- 添加上滑关闭功能

Closes #123
```

---

## 更新日志

### v1.0.0 (2025-02-09)

#### 新增
- ✅ 实现横竖屏强制锁定（竖屏）
- ✅ 实现下拉手势触发小程序容器
- ✅ 实现抽纸动画效果
- ✅ 实现上滑关闭小程序容器
- ✅ 添加下拉阻尼效果

#### 优化
- 🎨 优化下拉手势粘滞性
- 🎨 调整动画缓动曲线
- 🎨 添加透明度渐变效果

#### 修复
- 🐛 修复云打包中文文件名问题
- 🐛 修复小程序容器滑入速度问题
- 🐛 修复标准调试基座配置不生效问题

---

## 联系方式

- 开发者：Claude Code
- 项目路径：`/Volumes/DudaDate/微信小程序开发/会都销售app/会都销售app/`
- 文档更新日期：2025-02-09

---

**最后更新**: 2025-02-09
